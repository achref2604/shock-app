<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestion Protocoles - Coruscant Guard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --shock-red: #c0392b; --bg-dark: #0a0a0a; --card-bg: #161616; }
        body { font-family: 'Rajdhani', sans-serif; background-color: var(--bg-dark); color: #e0e0e0; background-image: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%); }
        h1, h2, h3, h4, h5, .nav-link, .btn { text-transform: uppercase; letter-spacing: 1px; }
        .text-shock { color: var(--shock-red) !important; text-shadow: 0 0 10px rgba(192, 57, 43, 0.3); }
        .btn-shock { background-color: var(--shock-red); border: none; color: white; font-weight: 600; }
        .btn-shock:hover { background-color: #a93226; box-shadow: 0 0 15px rgba(192, 57, 43, 0.5); color: white; }
        .card { background-color: var(--card-bg); border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card-header { border-bottom: 1px solid #333; background-color: rgba(192, 57, 43, 0.1); }
        .form-control, .form-select { background-color: #222; border: 1px solid #444; color: #fff; }
        .form-control:focus, .form-select:focus { background-color: #2a2a2a; border-color: var(--shock-red); color: #fff; }
        .nav-tabs { border-bottom: 2px solid #333; }
        .nav-link { color: #888; border: none; padding: 1rem 1.5rem; font-weight: 600; transition: all 0.3s; }
        .nav-link:hover { color: var(--shock-red); }
        .nav-link.active { background-color: transparent; color: var(--shock-red); border-bottom: 3px solid var(--shock-red); }
        .badge-done { background-color: #27ae60; color: white; }
        .badge-pending { background-color: #f39c12; color: #000; }
        .details-box { background-color: rgba(255,255,255,0.05); border-left: 3px solid var(--shock-red); }
        .alert-time { background-color: rgba(243, 156, 18, 0.2); border: 1px solid #f39c12; color: #f39c12; }
        .user-bar { position: absolute; top: 20px; right: 20px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--shock-red); }
        
        .admin-section { border-left: 2px solid var(--shock-red); padding-left: 15px; margin-bottom: 20px; }
        .tag-remove { cursor: pointer; color: #e74c3c; margin-left: 5px; }
    </style>
</head>
<body class="container py-5">

    <div class="user-bar" id="userZone"></div>

    <header class="text-center mb-5 mt-4">
        <h1 class="display-4 fw-bold text-shock">Coruscant Guard</h1>
        <p class="lead text-muted">Syst√®me de Gestion des D√©tentions</p>
    </header>

    <ul class="nav nav-tabs mb-4 justify-content-center">
        <li class="nav-item"><a class="nav-link active" href="#" onclick="changerOnglet('encours')">üì° Mandats</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="changerOnglet('historique')">üíæ Archives</a></li>
        <li class="nav-item" id="navAdmin" style="display:none;"><a class="nav-link" href="#" onclick="changerOnglet('admin')">‚öôÔ∏è Admin (Fox)</a></li>
    </ul>

    <div id="btnAdminZone" class="text-center mb-4" style="display:none;">
        <button class="btn btn-outline-danger btn-sm px-4 py-2" onclick="toggleForm()">‚ö†Ô∏è Ordonner un Protocole</button>
    </div>

    <div id="loginWarning" class="text-center mb-4 text-muted fst-italic">
        <small>Connexion requise.</small>
    </div>

    <div id="adminConfigPanel" class="row justify-content-center" style="display: none;">
        <div class="col-lg-10 mb-5">
            <div class="card border-warning">
                <div class="card-header text-center text-warning fw-bold py-3">CONFIGURATION SYST√àME (ADMIN ONLY)</div>
                <div class="card-body p-4">
                    <div class="admin-section">
                        <h5>üëÆ R√¥les Officiers (Acc√®s Total)</h5>
                        <p class="small text-muted">Copiez les IDs des r√¥les Discord ici.</p>
                        <div class="d-flex gap-2 mb-2">
                            <input type="text" id="newOfficerRole" class="form-control form-control-sm" placeholder="ID R√¥le">
                            <button onclick="addConfig('officerRoles')" class="btn btn-sm btn-success">Ajouter</button>
                        </div>
                        <div id="listOfficerRoles" class="d-flex flex-wrap gap-2"></div>
                    </div>
                    <div class="admin-section">
                        <h5>üî´ R√¥les Marines (Acc√®s Restreint)</h5>
                        <p class="small text-muted">Peuvent cr√©er/modifier, mais PAS valider ni restaurer.</p>
                        <div class="d-flex gap-2 mb-2">
                            <input type="text" id="newMarineRole" class="form-control form-control-sm" placeholder="ID R√¥le">
                            <button onclick="addConfig('marineRoles')" class="btn btn-sm btn-success">Ajouter</button>
                        </div>
                        <div id="listMarineRoles" class="d-flex flex-wrap gap-2"></div>
                    </div>
                    <div class="admin-section">
                        <h5>üè¥ R√©giments</h5>
                        <p class="small text-muted">Liste du menu d√©roulant.</p>
                        <div class="d-flex gap-2 mb-2">
                            <input type="text" id="newRegiment" class="form-control form-control-sm" placeholder="Nom R√©giment">
                            <button onclick="addConfig('regiments')" class="btn btn-sm btn-success">Ajouter</button>
                        </div>
                        <div id="listRegiments" class="d-flex flex-wrap gap-2"></div>
                    </div>
                    <div class="text-end">
                        <button onclick="saveConfig()" class="btn btn-warning fw-bold">Sauvegarder la Configuration</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="protocolFormPanel" style="display: none;">
        <div class="col-12 mb-5"> 
            <div class="card border-danger">
                <div class="card-header text-center text-shock fw-bold py-3" id="formTitle">‚ö†Ô∏è ORDONNER UN NOUVEAU PROTOCOLE</div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-3 border-end border-secondary pe-md-4">
                            <h5 class="text-muted mb-3"><i class="fas fa-user-shield"></i> L'Officier</h5>
                            <div class="mb-3"><label class="small text-muted">Votre Nom*</label><input type="text" id="auteurNom" class="form-control"></div>
                        </div>
                        <div class="col-md-9 ps-md-4">
                            <h5 class="text-muted mb-3"><i class="fas fa-bullseye"></i> Informations Cible</h5>
                            <div class="mb-2"><label class="small text-muted">Identit√©*</label><input type="text" id="cibleNom" class="form-control" placeholder="Matricule + Nom"></div>
                            <div class="row g-2 mb-2">
                                <div class="col-6"><label class="small text-muted">Grade*</label><input type="text" id="cibleGrade" class="form-control"></div>
                                <div class="col-6"><label class="small text-muted">R√©giment*</label>
                                    <select id="cibleRegiment" class="form-select"><option value="" disabled selected>Chargement...</option></select>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-6"><label class="small text-muted">Protocole*</label>
                                    <select id="protocole" class="form-select">
                                        <option value="" selected disabled>Choisir...</option>
                                        <option>Protocole 1</option><option>Protocole 2</option><option>Protocole 3</option><option>Protocole 4</option>
                                        <option>Protocole 5</option><option>Protocole 6</option><option>Protocole 7</option><option>Protocole 8</option>
                                    </select>
                                </div>
                                <div class="col-6"><label class="small text-muted">Temps (Opt.)</label><input type="text" id="tempsRestant" class="form-control border-warning text-warning"></div>
                            </div>
                            <div class="mb-2"><label class="small text-muted">Raison*</label><input type="text" id="raison" class="form-control"></div>
                            <div class="mb-2"><input type="text" id="steamid" class="form-control form-control-sm text-secondary border-secondary" placeholder="SteamID64 (Facultatif)"></div>
                            <h5 class="text-muted mb-2 mt-4">D√©tails</h5>
                            <textarea id="details" class="form-control" rows="4"></textarea>
                        </div>
                    </div>
                    <div class="text-center mt-4 pt-3 border-top border-secondary">
                        <button id="btnSubmit" onclick="envoyerProtocole()" class="btn btn-shock btn-lg px-5">Transmettre</button>
                        <button id="btnCancel" onclick="resetForm()" class="btn btn-outline-secondary btn-lg px-3 ms-2" style="display:none;">Annuler</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="listeSection">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-2">
            <h4 id="titreListe" class="m-0"><span class="text-shock">‚ñ∫</span> Liste des Mandats</h4>
            <span class="badge bg-secondary" id="compteur">0 dossiers</span>
        </div>
        <div id="listeProtocoles" class="row g-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api/protocoles';
        
        let currentData = [];
        let configData = { officerRoles: [], marineRoles: [], regiments: [] };
        let editingId = null; 
        
        let user = { connecte: false, isAdmin: false, isOfficer: false, isMarine: false };

        async function init() {
            await fetchConfig(); 
            await checkUserStatus();
        }

        async function checkUserStatus() {
            try {
                const res = await fetch('/auth/user');
                const data = await res.json();
                user = data;

                const userZone = document.getElementById('userZone');
                const btnZone = document.getElementById('btnAdminZone');
                const warning = document.getElementById('loginWarning');
                const navAdmin = document.getElementById('navAdmin');

                if (user.connecte) {
                    let badge = '<span class="badge bg-secondary">SOLDAT</span>';
                    if (user.isAdmin) badge = '<span class="badge bg-warning text-dark">FOX (ADMIN)</span>';
                    else if (user.isOfficer) badge = '<span class="badge bg-danger">SHOCK</span>';
                    else if (user.isMarine) badge = '<span class="badge bg-info text-dark">MARINE</span>';

                    userZone.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <img src="${data.avatar}" class="avatar" alt="Avatar">
                            <span class="fw-bold">${data.nickname}</span>
                            ${badge}
                            <a href="/auth/logout" class="btn btn-sm btn-outline-danger"><i class="fas fa-sign-out-alt"></i></a>
                        </div>`;
                    
                    const canEdit = user.isAdmin || user.isOfficer || user.isMarine;
                    btnZone.style.display = canEdit ? 'block' : 'none';
                    navAdmin.style.display = user.isAdmin ? 'block' : 'none';
                    warning.style.display = 'none';

                    if(!canEdit) {
                        warning.innerHTML = "<small>Connect√© en lecture seule.</small>";
                        warning.style.display = 'block';
                    }
                } else {
                    userZone.innerHTML = `<a href="/auth/discord" class="btn btn-outline-light btn-sm"><i class="fab fa-discord"></i> Connexion</a>`;
                    btnZone.style.display = 'none';
                    warning.style.display = 'block';
                }
                chargerEnCours(); 
            } catch (e) { console.error("Erreur auth", e); }
        }

        async function fetchConfig() {
            try {
                const res = await fetch('/api/config');
                configData = await res.json();
                renderRegimentsSelect();
            } catch(e) {}
        }

        function renderRegimentsSelect() {
            const select = document.getElementById('cibleRegiment');
            select.innerHTML = '<option value="" disabled selected>Choisir...</option>';
            configData.regiments.forEach(reg => {
                select.innerHTML += `<option value="${reg}">${reg}</option>`;
            });
        }

        function toggleForm() {
            const panel = document.getElementById('protocolFormPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function changerOnglet(type) {
            resetForm();
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            const adminPanel = document.getElementById('adminConfigPanel');
            const listPanel = document.getElementById('listeSection');
            const btnZone = document.getElementById('btnAdminZone');
            const titre = document.getElementById('titreListe');

            adminPanel.style.display = 'none';
            listPanel.style.display = 'block';
            document.getElementById('protocolFormPanel').style.display = 'none';

            if(type === 'admin') {
                if(!user.isAdmin) return alert("Acc√®s refus√©");
                listPanel.style.display = 'none';
                btnZone.style.display = 'none';
                adminPanel.style.display = 'block';
                renderAdminUI();
            } else if(type === 'encours') {
                titre.innerHTML = '<span class="text-shock">‚ñ∫</span> Mandats en Cours';
                btnZone.style.display = (user.isAdmin || user.isOfficer || user.isMarine) ? 'block' : 'none';
                chargerEnCours();
            } else {
                titre.innerHTML = '<span class="text-shock">‚ñ∫</span> Archives';
                btnZone.style.display = 'none';
                chargerHistorique();
            }
        }

        function renderAdminUI() {
            const listOfficer = document.getElementById('listOfficerRoles');
            const listMarine = document.getElementById('listMarineRoles');
            const listRegs = document.getElementById('listRegiments');

            listOfficer.innerHTML = configData.officerRoles.map(r => `<span class="badge bg-secondary">${r} <i class="fas fa-times tag-remove" onclick="removeConfig('officerRoles', '${r}')"></i></span>`).join('');
            listMarine.innerHTML = configData.marineRoles.map(r => `<span class="badge bg-secondary">${r} <i class="fas fa-times tag-remove" onclick="removeConfig('marineRoles', '${r}')"></i></span>`).join('');
            listRegs.innerHTML = configData.regiments.map(r => `<span class="badge bg-secondary">${r} <i class="fas fa-times tag-remove" onclick="removeConfig('regiments', '${r}')"></i></span>`).join('');
        }

        function addConfig(key) {
            let inputId = '';
            if(key === 'officerRoles') inputId = 'newOfficerRole';
            if(key === 'marineRoles') inputId = 'newMarineRole';
            if(key === 'regiments') inputId = 'newRegiment';
            const val = document.getElementById(inputId).value.trim();
            if(!val) return;
            configData[key].push(val);
            document.getElementById(inputId).value = '';
            renderAdminUI();
        }

        function removeConfig(key, val) {
            configData[key] = configData[key].filter(item => item !== val);
            renderAdminUI();
        }

        async function saveConfig() {
            await fetch('/api/config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(configData)
            });
            alert("Configuration sauvegard√©e !");
            renderRegimentsSelect();
        }

        async function chargerEnCours() {
            const res = await fetch('/api/protocoles');
            currentData = await res.json();
            afficherCartes(currentData, true);
        }

        async function chargerHistorique() {
            const res = await fetch('/api/historique');
            currentData = await res.json();
            afficherCartes(currentData, false);
        }

        function afficherCartes(data, estEnCours) {
            const container = document.getElementById('listeProtocoles');
            container.innerHTML = '';
            document.getElementById('compteur').innerText = `${data.length} dossiers`;

            if(data.length === 0) {
                container.innerHTML = `<div class="col-12 text-center py-5 text-muted"><h3 class="fw-light">Aucun dossier.</h3></div>`;
                return;
            }

            data.forEach(p => {
                const isDone = p.statut === 'Effectu√©';
                const badge = isDone 
                    ? '<span class="badge badge-done rounded-pill px-3 py-2">‚úÖ EFFECTU√â</span>' 
                    : '<span class="badge badge-pending rounded-pill px-3 py-2">‚è≥ EN ATTENTE</span>';
                
                let actionButtons = '';
                const canEdit = user.isAdmin || user.isOfficer || user.isMarine;
                const canValidate = user.isAdmin || user.isOfficer;

                if (estEnCours && canEdit) {
                    let btnValider = canValidate ? `<button onclick="valider('${p._id}')" class="btn btn-outline-success flex-grow-1 fw-bold">Confirmer</button>` : '';
                    actionButtons = `
                    <div class="card-footer bg-transparent border-top-0 pt-0 d-flex gap-2">
                        ${btnValider}
                        <button onclick="preparerAction('${p._id}', 'modifier')" class="btn btn-outline-warning" title="Modifier">‚úèÔ∏è</button>
                        <button onclick="preparerAction('${p._id}', 'dupliquer')" class="btn btn-outline-info" title="Dupliquer">üìã</button>
                    </div>`;
                } else if (!estEnCours && canValidate) {
                    actionButtons = `
                    <div class="card-footer bg-transparent border-top-0 pt-0">
                        <button onclick="restaurer('${p._id}')" class="btn btn-outline-light w-100 fw-bold">‚Ü©Ô∏è Restaurer</button>
                    </div>`;
                }

                let deleteBtn = '';
                if(user.isAdmin) {
                    deleteBtn = `<button onclick="supprimer('${p._id}')" class="btn btn-sm btn-danger ms-2" title="Supprimer d√©finitivement"><i class="fas fa-trash"></i></button>`;
                }

                let timeAlert = (p.tempsRestant && !isDone) ? `<div class="alert-time p-2 rounded mb-2 text-center fw-bold">‚ö†Ô∏è RESTANT : ${p.tempsRestant}</div>` : '';
                
                let logName = p.discordNick || p.discordUser;
                if (p.discordNick && p.discordUser && p.discordNick !== p.discordUser) {
                    logName = `${p.discordNick} (${p.discordUser})`;
                }
                const discordInfo = logName ? `<br><small class="text-secondary"><i class="fab fa-discord"></i> Log: ${logName}</small>` : '';
                const steamInfo = p.targetSteamID ? `<small class="text-muted d-block mt-1" style="font-size:0.7rem">${p.targetSteamID}</small>` : '';
                const dateStr = new Date(p.date).toLocaleString().slice(0, -3);

                container.innerHTML += `
                <div class="col-12" style="${estEnCours ? '' : 'opacity:0.8; filter:grayscale(20%);'}">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div><span class="fw-bold text-white fs-5">${p.cibleNom}</span> <span class="small text-muted ms-2">${p.cibleGrade} - ${p.cibleRegiment}</span></div>
                            <div class="d-flex align-items-center gap-2">
                                ${badge}
                                ${deleteBtn}
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-9">
                                     <div class="row mb-3 g-2">
                                        <div class="col-md-4"><div class="p-2 bg-dark rounded border border-secondary"><small class="text-muted d-block ls-1">SANCTION</small><span class="fw-bold text-danger">${p.protocoleType}</span></div></div>
                                        <div class="col-md-8"><div class="p-2 bg-dark rounded border border-secondary"><small class="text-muted d-block ls-1">RAISON</small><span class="fst-italic">"${p.raison}"</span></div></div>
                                    </div>
                                    ${p.details ? `<div class="details-box p-3 rounded bg-dark text-light small mb-2">${p.details}</div>` : ''}
                                    ${timeAlert}
                                </div>
                                <div class="col-md-3 border-start border-secondary ps-4 d-flex flex-column justify-content-center">
                                    <div class="small text-muted mb-1">üìÖ ${dateStr}</div>
                                    <div class="mb-1">Officier: <strong>${p.auteurNom}</strong></div>
                                    ${discordInfo}
                                    ${steamInfo}
                                </div>
                            </div>
                        </div>
                        ${actionButtons}
                    </div>
                </div>`;
            });
        }

        function preparerAction(id, mode) {
            const item = currentData.find(p => p._id === id);
            document.getElementById('auteurNom').value = item.auteurNom;
            document.getElementById('cibleNom').value = item.cibleNom;
            document.getElementById('cibleGrade').value = item.cibleGrade;
            document.getElementById('cibleRegiment').value = item.cibleRegiment;
            document.getElementById('steamid').value = item.targetSteamID || '';
            document.getElementById('protocole').value = item.protocoleType;
            document.getElementById('raison').value = item.raison;
            document.getElementById('details').value = item.details;
            document.getElementById('tempsRestant').value = item.tempsRestant || '';

            document.getElementById('protocolFormPanel').style.display = 'block';
            document.getElementById('protocolFormPanel').scrollIntoView({ behavior: 'smooth' });

            if(mode === 'modifier') {
                editingId = id;
                document.getElementById('formTitle').innerText = "üìù MODIFICATION";
                document.getElementById('btnSubmit').innerText = "Sauvegarder";
                document.getElementById('btnSubmit').className = "btn btn-warning btn-lg px-5";
                document.getElementById('btnCancel').style.display = "inline-block";
            } else {
                editingId = null;
                document.getElementById('formTitle').innerText = "üìã DUPLICATION";
                document.getElementById('btnSubmit').innerText = "Cr√©er la copie";
                document.getElementById('btnSubmit').className = "btn btn-shock btn-lg px-5";
                document.getElementById('btnCancel').style.display = "inline-block";
            }
        }

        function resetForm() {
            editingId = null;
            document.getElementById('formTitle').innerText = "‚ö†Ô∏è ORDONNER UN NOUVEAU PROTOCOLE";
            document.getElementById('btnSubmit').innerText = "Transmettre";
            document.getElementById('btnSubmit').className = "btn btn-shock btn-lg px-5";
            document.getElementById('btnCancel').style.display = "none";
            document.getElementById('cibleNom').value = '';
            document.getElementById('cibleGrade').value = '';
            document.getElementById('cibleRegiment').value = '';
            document.getElementById('steamid').value = '';
            document.getElementById('protocole').value = '';
            document.getElementById('raison').value = '';
            document.getElementById('details').value = '';
            document.getElementById('tempsRestant').value = '';
        }

        async function envoyerProtocole() {
            const body = {
                auteurNom: document.getElementById('auteurNom').value,
                cibleNom: document.getElementById('cibleNom').value,
                cibleGrade: document.getElementById('cibleGrade').value,
                cibleRegiment: document.getElementById('cibleRegiment').value,
                targetSteamID: document.getElementById('steamid').value,
                protocoleType: document.getElementById('protocole').value,
                raison: document.getElementById('raison').value,
                details: document.getElementById('details').value,
                tempsRestant: document.getElementById('tempsRestant').value
            };

            if(!body.cibleNom || !body.cibleGrade || !body.cibleRegiment || !body.protocoleType || !body.raison || !body.auteurNom) {
                return alert("Champs obligatoires manquants.");
            }

            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `${API_URL}/${editingId}` : API_URL;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if(res.ok) {
                    alert('‚úÖ OK');
                    resetForm();
                    chargerEnCours();
                    if(!editingId) toggleForm();
                } else {
                    alert('Erreur ou Permissions insuffisantes.');
                }
            } catch(e) { alert("Erreur r√©seau"); }
        }

        async function valider(id) {
            if(!confirm("Valider ?")) return;
            const res = await fetch(`${API_URL}/${id}/valider`, { method: 'PUT' });
            if(res.ok) chargerEnCours();
            else alert("Permission refus√©e");
        }

        async function restaurer(id) {
            const temps = prompt("Temps restant ?");
            const res = await fetch(`${API_URL}/${id}/restaurer`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tempsRestant: temps })
            });
            if(res.ok) chargerHistorique();
            else alert("Permission refus√©e");
        }

        async function supprimer(id) {
            if(!confirm("‚ö†Ô∏è SUPPRESSION D√âFINITIVE ‚ö†Ô∏è\n√ätes-vous s√ªr de vouloir supprimer ce dossier ? Cette action est irr√©versible.")) return;
            try {
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    // On recharge la liste o√π on se trouve (En cours ou Historique)
                    // Le moyen le plus simple est de recharger la page ou de deviner
                    // Mais comme on ne sait pas o√π on est, on recharge la liste actuelle
                    const activeTab = document.querySelector('.nav-link.active').getAttribute('onclick');
                    if(activeTab.includes('encours')) chargerEnCours();
                    else chargerHistorique();
                } else {
                    alert("Erreur : Seul l'Admin peut supprimer.");
                }
            } catch(e) { alert("Erreur serveur"); }
        }

        init();
    </script>
</body>
</html>
