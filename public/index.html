<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestion des Protocoles</title>
    
    <link rel="icon" type="image/png" href="/favicon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --shock-red: #c0392b; 
            --signal-orange: #e67e22; 
            --bg-dark: #141414; 
            --card-bg: #2b2b2b; 
        }
        
        html { overflow-y: scroll; }

        body { 
            font-family: 'Rajdhani', sans-serif; 
            background-color: var(--bg-dark); 
            color: #e0e0e0; 
            background-image: radial-gradient(circle at center, #252525 0%, #141414 100%);
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
            position: relative; 
        }
        h1, h2, h3, h4, h5, .nav-link, .btn { text-transform: uppercase; letter-spacing: 1px; }
        
        .text-shock { color: var(--shock-red) !important; text-shadow: 0 0 10px rgba(192, 57, 43, 0.3); }
        .btn-shock { background-color: var(--shock-red); border: none; color: white; font-weight: 600; }
        .btn-shock:hover { background-color: #a93226; box-shadow: 0 0 15px rgba(192, 57, 43, 0.5); color: white; }
        
        .text-signal { color: var(--signal-orange) !important; text-shadow: 0 0 10px rgba(230, 126, 34, 0.3); }
        .text-matricule { color: var(--shock-red) !important; text-shadow: 0 0 10px rgba(230, 34, 34, 0.3); }
        
        .border-signal { border-color: var(--signal-orange) !important; }
        
        /* Bouton Orange Plein */
        .btn-signal { background-color: var(--signal-orange); border: none; color: white; font-weight: 600; }
        .btn-signal:hover { background-color: #d35400; box-shadow: 0 0 15px rgba(230, 126, 34, 0.5); color: white; }

        /* Bouton Orange Contour (Outline) */
        .btn-outline-signal {
            color: var(--signal-orange);
            border: 2px solid var(--signal-orange);
            background-color: transparent;
            font-weight: 600;
        }
        .btn-outline-signal:hover {
            background-color: var(--signal-orange);
            color: white;
            box-shadow: 0 0 15px rgba(230, 126, 34, 0.5);
        }

        .card { background-color: var(--card-bg) !important; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        .card-header { border-bottom: 1px solid #333; background-color: rgba(192, 57, 43, 0.1); }
        .card-remettre { border-bottom: 1px solid #333; background-color: rgba(192, 115, 43, 0.1); }
        .form-control, .form-select { background-color: #2a2a2a; border: 1px solid #444; color: #fff; }
        .form-control:focus, .form-select:focus { background-color: #333; border-color: var(--shock-red); color: #fff; }
        .nav-tabs { border-bottom: 2px solid #333; }
        .nav-link { color: #888; border: none; padding: 1rem 1.5rem; font-weight: 600; transition: all 0.3s; }
        .nav-link:hover { color: var(--shock-red); }
        .nav-link.active { background-color: transparent; color: var(--shock-red); border-bottom: 3px solid var(--shock-red); }
        .badge-done { background-color: #27ae60; color: white; }
        .badge-pending { background-color: #f39c12; color: #000; }
        .alert-time { background-color: rgba(243, 156, 18, 0.2); border: 1px solid #f39c12; color: #f39c12; }
        .user-bar { position: absolute; top: 20px; right: 20px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--shock-red); }
        .admin-section { border-left: 2px solid var(--shock-red); padding-left: 15px; margin-bottom: 20px; }
        .tag-remove { cursor: pointer; color: #e74c3c; margin-left: 5px; }
        .ls-1 { letter-spacing: 1px; font-weight: 600; font-size: 0.75rem; }
        .user-text { white-space: pre-wrap; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; display: block; }
        
        .rappel-card { border: 1px solid #c0392b !important; box-shadow: 0 0 10px rgba(192, 57, 43, 0.2); }
        .rappel-header { border-bottom: 1px solid #c0392b !important; color: white; font-weight: bold; }
        .generated-box { background: #2a2a2a; border: 1px dashed #666; padding: 10px; font-family: monospace; font-size: 0.85rem; color: #aaa; margin-top: 10px; cursor: pointer; }
        .generated-box:hover { border-color: #fff; color: #fff; }
        
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .sanction-alert { background-color: #c0392b; color: white; text-align: center; font-weight: bold; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-transform: uppercase; animation: pulse-red 2s infinite; letter-spacing: 1px; box-shadow: 0 0 10px rgba(192, 57, 43, 0.5); }
    
        /* STYLE POUR SUSPENSION */
        .alert-suspended { background-color: rgba(241, 196, 15, 0.2); border: 1px solid #f1c40f; color: #f1c40f; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 10px; }

        .main-wrapper { max-width: 1800px; margin: 0 auto; }

        /* MODALES */
        .modal-content { background-color: var(--card-bg); border: 1px solid #444; color: white; }
        .modal-header { border-bottom: 1px solid #444; }
        .modal-footer { border-top: 1px solid #444; }
        .modal-title { color: var(--shock-red); font-weight: bold; letter-spacing: 1px; }
        .btn-close { filter: invert(1); }
    </style>
</head>
<body class="container-fluid py-5 px-5">

    <div class="main-wrapper">

        <div class="user-bar" id="userZone"></div>

        <header class="text-center mb-5 mt-4">
            <h1 class="display-4 fw-bold text-shock">Gestion des Protocoles</h1>
            <p class="lead text-muted">Shock Trooper - Flotte Cosmos</p>
        </header>

        <ul class="nav nav-tabs mb-4 justify-content-center">
            <li class="nav-item" id="navSignalement" style="display:none;"><a class="nav-link" href="#" onclick="changerOnglet('signalement')">‚ö° Signalement Protocole</a></li>
            <li class="nav-item"><a class="nav-link active" href="#" onclick="changerOnglet('encours')">üï∞Ô∏è Protocole √† Remettre</a></li>
            <li class="nav-item" id="navDelais" style="display:none;"><a class="nav-link" href="#" onclick="changerOnglet('delais')">‚è≥ D√©lai Protocole</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="changerOnglet('historique')">üíæ Archives</a></li>
            <li class="nav-item" id="navAdmin" style="display:none;"><a class="nav-link" href="#" onclick="changerOnglet('admin')">‚öôÔ∏è Admin</a></li>
        </ul>

        <div id="btnAdminZone" class="text-center mb-4" style="display:none;">
            <button class="btn btn-outline-signal btn-sm px-4 py-2" onclick="toggleForm()">‚ûï Ordonner un Protocole √† Remettre</button>
        </div>

        <div id="loginWarning" class="text-center mb-4 text-muted fst-italic">
            <small>Connexion Discord requise.</small>
        </div>

        <div id="adminConfigPanel" class="row" style="display: none;">
            <div class="col-12 mb-5">
                <div class="card border-warning">
                    <div class="card-header text-center text-warning fw-bold py-3">CONFIGURATION DU SITE</div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="admin-section" style="border-color: #f1c40f;">
                                    <h5>üëë Membres Admins</h5>
                                    <div class="d-flex gap-2 mb-2"><input type="text" id="newAdminRole" class="form-control form-control-sm" placeholder="ID R√¥le Discord"><button onclick="addConfig('adminRoles')" class="btn btn-sm btn-success">+</button></div>
                                    <div id="listAdminRoles" class="d-flex flex-wrap gap-2 mb-2"></div>
                                    
                                    <div class="d-flex gap-2 mb-2"><input type="text" id="newAdminUser" class="form-control form-control-sm" placeholder="ID User Admin"><button onclick="addConfig('adminUsers')" class="btn btn-sm btn-success">+</button></div>
                                    <div id="listAdminUsers" class="d-flex flex-wrap gap-2 mb-3"></div>

                                    <hr class="border-secondary my-2">
                                    <small class="text-muted d-block mb-1">Officiers Shock (ID User uniquement) :</small>
                                    <div class="d-flex gap-2 mb-2"><input type="text" id="newShockUser" class="form-control form-control-sm" placeholder="ID User Shock Officer"><button onclick="addConfig('shockOfficerUsers')" class="btn btn-sm btn-success">+</button></div>
                                    <div id="listShockUsers" class="d-flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="admin-section">
                                    <h5>üëÆ Accr√©ditations</h5>
                                    <div class="d-flex gap-2 mb-2"><input type="text" id="newOfficerRole" class="form-control form-control-sm" placeholder="ID Signalement, Remettre, D√©lai"><button onclick="addConfig('officerRoles')" class="btn btn-sm btn-success">+</button></div>
                                    <div id="listOfficerRoles" class="d-flex flex-wrap gap-2 mb-3"></div>
                                    <div class="d-flex gap-2 mb-2"><input type="text" id="newMarineRole" class="form-control form-control-sm" placeholder="ID Remettre"><button onclick="addConfig('marineRoles')" class="btn btn-sm btn-success">+</button></div>
                                    <div id="listMarineRoles" class="d-flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="admin-section">
                                    <h5>üè¥ Ajouter R√©giment</h5>
                                    <div class="d-flex gap-2 mb-2"><input type="text" id="newRegimentName" class="form-control form-control-sm" placeholder="Nom du R√©giment (Ex: 104th)"><button onclick="addNewRegiment()" class="btn btn-sm btn-success">Cr√©er</button></div>
                                    <p class="small text-muted mb-3">Configurez les r√©glages des r√©giments ci-dessous.</p>
                                    <hr class="border-secondary my-2">
                                    <h5 class="text-danger">üö´ Utilisateurs Bannis</h5>
                                    <div class="d-flex gap-2 mb-2"><input type="text" id="newBannedUser" class="form-control form-control-sm" placeholder="ID User Discord"><button onclick="addConfig('bannedUsers')" class="btn btn-sm btn-danger">+</button></div>
                                    <div id="listBannedUsers" class="d-flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h5 class="text-center text-muted mb-3">CONFIGURATIONS DES R√âGLAGES DES R√âGIMENTS</h5>
                        <div id="regimentConfigList" class="row g-3"></div>
                        <div class="text-end mt-4"><button onclick="saveConfig()" class="btn btn-warning fw-bold px-5">SAUVEGARDER TOUS LES R√âGLAGES</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="signalementPanel" style="display: none;">
            <div class="col-12 mb-5">
                <div class="card border-danger">
                    <div class="card-header text-center text-shock fw-bold py-3">‚ö° SIGNALEMENT PROTOCOLE</div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-3 border-end border-secondary pe-md-4">
                                <h5 class="text-muted mb-3"><i class="fas fa-user-shield"></i> Le Shock</h5>
                                <div class="mb-3"><label class="small text-muted">Votre Identit√©*</label><input type="text" id="sigShockName" class="form-control fw-bold text-matricule" placeholder="Matricule + Nom"></div>
                            </div>
                            <div class="col-md-9 ps-md-4">
                                <h5 class="text-muted mb-3"><i class="fas fa-bullseye"></i> Clone Sanctionn√©</h5>
                                <div class="mb-2"><label class="small text-muted">Son Identit√©*</label><input type="text" id="sigCibleNom" class="form-control" placeholder="Matricule + Nom"></div>
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><label class="small text-muted">Son Grade*</label><input type="text" id="sigCibleGrade" class="form-control"></div>
                                    <div class="col-6"><label class="small text-muted">Son R√©giment*</label><select id="sigCibleRegiment" class="form-select"><option value="" disabled selected>Chargement...</option></select></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><label class="small text-muted">Protocole*</label><select id="sigProtocole" class="form-select"><option value="" selected disabled>Choisir...</option><option>Protocole 1</option><option>Protocole 2</option><option>Protocole 3</option><option>Protocole 4</option><option>Protocole 5</option><option>Protocole 6</option><option>Protocole 7</option><option>Protocole 8</option><option>Protocole 9</option><option>Protocole 10</option></select></div>
                                    <div class="col-6"><label class="small text-muted">Ordonn√© / Demand√© par</label><input type="text" id="sigOrderedBy" class="form-control" placeholder="Laisser vide si c'est vous qui l'avez ordonn√©"></div>
                                </div>
                                <div class="mb-2"><label class="small text-muted">Raison*</label><textarea id="sigRaison" class="form-control" rows="2"></textarea></div>
                                <div class="mb-2"><label class="small text-muted">D√©tails</label><textarea id="sigDetails" class="form-control" rows="4"></textarea></div>
                                <div class="mb-2"><label class="small text-muted">SteamID</label><input type="text" id="sigSteamID" class="form-control form-control-sm text-secondary border-secondary" placeholder="√Ä remplir si 408th, CT ASP Blanc, CCT ou job VIP"></div>
                            </div>
                        </div>
                        <div class="text-center mt-4 pt-3 border-top border-secondary">
                            <button type="button" onclick="envoyerSignalement()" class="btn btn-shock btn-lg px-5 fw-bold">Envoyer le Signalement</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="protocolFormPanel" style="display: none;">
            <div class="col-12 mb-5"> 
                <div class="card border-signal">
                    <div class="card-remettre text-center text-signal fw-bold py-3" id="formTitle">üï∞Ô∏è ORDONNER UN NOUVEAU PROTOCOLE A REMETTRE</div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-3 border-end border-secondary pe-md-4">
                                <h5 class="text-muted mb-3"><i class="fas fa-user-shield"></i> Personne qui ordonne le protocole</h5>
                                <div class="mb-3"><label class="small text-muted">Votre Identit√©*</label><input type="text" id="auteurNom" class="form-control fw-bold text-signal" placeholder="R√©giment + Gade + Matricule + Nom"></div>
                            </div>
                            <div class="col-md-9 ps-md-4">
                                <h5 class="text-muted mb-3"><i class="fas fa-bullseye"></i> Informations du Clone √† Sanctionner</h5>
                                <div class="mb-2"><label class="small text-muted">Son Identit√©*</label><input type="text" id="cibleNom" class="form-control" placeholder="Matricule + Nom"></div>
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><label class="small text-muted">Son Grade*</label><input type="text" id="cibleGrade" class="form-control"></div>
                                    <div class="col-6"><label class="small text-muted">Son R√©giment*</label><select id="cibleRegiment" class="form-select"><option value="" disabled selected>Chargement...</option></select></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><label class="small text-muted">Protocole*</label><select id="protocole" class="form-select"><option value="" selected disabled>Choisir...</option><option>Protocole 1</option><option>Protocole 2</option><option>Protocole 3</option><option>Protocole 4</option><option>Protocole 5</option><option>Protocole 6</option><option>Protocole 7</option><option>Protocole 8</option><option>Protocole 9</option><option>Protocole 10</option></select></div>
                                    <div class="col-6">
                                        <label class="small text-muted">Temps Restant (min)</label>
                                        <div class="input-group">
                                            <input type="text" id="tempsRestant" class="form-control border-warning text-warning" placeholder="ex: 15">
                                            <div class="input-group-text bg-dark border-warning">
                                                <input class="form-check-input mt-0" type="checkbox" id="notifyManager" title="Pr√©venir le g√©rant sur Discord (recommand√©)">
                                                <span class="small ms-2 text-warning"><i class="fas fa-bell"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-2"><label class="small text-muted">Raison*</label><textarea id="raison" class="form-control" rows="2"></textarea></div>
                                <div class="mb-2"><label class="small text-muted">D√©tails</label><textarea id="details" class="form-control" rows="4"></textarea></div>
                                <div class="mb-2"><label class="small text-muted">SteamID</label><input type="text" id="steamid" class="form-control form-control-sm text-secondary border-secondary" placeholder="√Ä remplir si 408th, CT ASP Blanc, CCT ou job VIP"></div>
                            </div>
                        </div>
                        <div class="text-center mt-4 pt-3 border-top border-secondary">
                            <button type="button" id="btnSubmit" onclick="envoyerProtocole()" class="btn btn-signal btn-lg px-5">Transmettre</button>
                            <button type="button" id="btnCancel" onclick="resetForm()" class="btn btn-outline-secondary btn-lg px-3 ms-2" style="display:none;">Annuler</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="listeSection">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-2">
                <h4 id="titreListe" class="m-0"><span class="text-shock">‚ñ∫</span> Liste</h4>
                <span class="badge bg-secondary" id="compteur">0 dossiers</span>
            </div>
            <div id="listeProtocoles" class="row g-4"></div>
        </div>

        <footer class="text-center mt-5 mb-3 text-muted small">
            Site r√©alis√© par Achref
        </footer>

    </div>

    <div class="modal fade" id="customAlertModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">INFORMATION</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="customAlertBody"></div>
                <div class="modal-footer"><button type="button" class="btn btn-shock" data-bs-dismiss="modal">OK</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">CONFIRMATION</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="customConfirmBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnConfirmNo">Annuler</button>
                    <button type="button" class="btn btn-shock" id="btnConfirmYes">Confirmer</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="customPromptModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="customPromptTitle">SAISIE REQUISE</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p id="customPromptBody" class="mb-2"></p>
                    <input type="text" id="customPromptInput" class="form-control" autocomplete="off">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnPromptCancel">Annuler</button>
                    <button type="button" class="btn btn-shock" id="btnPromptOk">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="customValidationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">APPLICATION PROTOCOLE</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small">Votre Matricule + Nom*</label>
                        <input type="text" id="valInputName" class="form-control" placeholder="ex: 4789 Achref">
                    </div>
                    <div class="mb-1">
                        <label class="form-label text-muted small">Commentaire (Optionnel)</label>
                        <textarea id="valInputComment" class="form-control" rows="3" placeholder="Si vous avez quelque chose √† ajouter..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnValCancel">Annuler</button>
                    <button type="button" class="btn btn-shock" id="btnValOk">VALIDER L'APPLICATION</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="restoreModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">RESTAURER PROTOCOLE</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p class="text-muted small">Le protocole a-t-il √©t√© commenc√© mais pas fini ?</p>
                    <div class="mb-3">
                        <label class="form-label small">Temps Restant (min)</label>
                        <input type="text" id="restoreTimeInput" class="form-control" placeholder="Laisser vide si non commenc√©">
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="restoreNotifyInput">
                        <label class="form-check-label text-warning" for="restoreNotifyInput">Pr√©venir le g√©rant sur Discord (recommand√©)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-shock" onclick="confirmerRestauration()">Restaurer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api/protocoles';
        let currentData = [];
        let configData = { adminRoles: [], adminUsers: [], shockOfficerUsers: [], bannedUsers: [], officerRoles: [], marineRoles: [], regiments: [] };
        let editingId = null; 
        let user = { connecte: false, id: null, isAdmin: false, isShockOfficer: false, isOfficer: false, isMarine: false, isBanned: false };

        // Variables pour restauration
        let restoreId = null;

        const alertModal = new bootstrap.Modal(document.getElementById('customAlertModal'));
        const confirmModal = new bootstrap.Modal(document.getElementById('customConfirmModal'));
        const promptModal = new bootstrap.Modal(document.getElementById('customPromptModal'));
        const validationModal = new bootstrap.Modal(document.getElementById('customValidationModal'));
        const restoreModal = new bootstrap.Modal(document.getElementById('restoreModal'));

        // --- S√âCURIT√â XSS ---
        function escapeHtml(text) {
            if (text === null || text === undefined) return "";
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function customAlert(message) { document.getElementById('customAlertBody').innerText = message; alertModal.show(); }
        
        function customConfirm(message) { 
            return new Promise((resolve) => { 
                document.getElementById('customConfirmBody').innerText = message; 
                const btnYes = document.getElementById('btnConfirmYes'); 
                const btnNo = document.getElementById('btnConfirmNo'); 
                
                const newYes = btnYes.cloneNode(true); 
                const newNo = btnNo.cloneNode(true); 
                btnYes.parentNode.replaceChild(newYes, btnYes); 
                btnNo.parentNode.replaceChild(newNo, btnNo); 
                
                newYes.onclick = () => { confirmModal.hide(); resolve(true); }; 
                newNo.onclick = () => { confirmModal.hide(); resolve(false); }; 
                confirmModal.show(); 
            }); 
        }
        
        function customPrompt(message, title = "SAISIE REQUISE") { 
            return new Promise((resolve) => { 
                document.getElementById('customPromptTitle').innerText = title; 
                document.getElementById('customPromptBody').innerText = message; 
                const input = document.getElementById('customPromptInput'); 
                input.value = ''; 
                const btnOk = document.getElementById('btnPromptOk'); 
                const btnCancel = document.getElementById('btnPromptCancel'); 
                
                const newOk = btnOk.cloneNode(true); 
                const newCancel = btnCancel.cloneNode(true); 
                btnOk.parentNode.replaceChild(newOk, btnOk); 
                btnCancel.parentNode.replaceChild(newCancel, btnCancel); 
                
                newOk.onclick = () => { promptModal.hide(); resolve(input.value); }; 
                newCancel.onclick = () => { promptModal.hide(); resolve(null); }; 
                
                document.getElementById('customPromptModal').addEventListener('shown.bs.modal', () => { input.focus(); }, { once: true }); 
                promptModal.show(); 
            }); 
        }

        function askValidationDetails() {
            return new Promise((resolve) => {
                const nameInput = document.getElementById('valInputName');
                const commentInput = document.getElementById('valInputComment');
                
                // Reset fields
                nameInput.value = '';
                commentInput.value = '';

                const btnOk = document.getElementById('btnValOk');
                const btnCancel = document.getElementById('btnValCancel');

                const newOk = btnOk.cloneNode(true);
                const newCancel = btnCancel.cloneNode(true);
                btnOk.parentNode.replaceChild(newOk, btnOk);
                btnCancel.parentNode.replaceChild(newCancel, btnCancel);

                newOk.onclick = () => {
                    const name = nameInput.value.trim();
                    const comment = commentInput.value.trim();
                    
                    if (name === "") {
                        nameInput.classList.add('is-invalid');
                        setTimeout(() => nameInput.classList.remove('is-invalid'), 2000);
                        return;
                    }
                    
                    validationModal.hide();
                    resolve({ name, comment });
                };

                newCancel.onclick = () => {
                    validationModal.hide();
                    resolve(null);
                };

                document.getElementById('customValidationModal').addEventListener('shown.bs.modal', () => { nameInput.focus(); }, { once: true });
                validationModal.show();
            });
        }

        async function init() { await fetchConfig(); await checkUserStatus(); }

        async function checkUserStatus() {
            try {
                const res = await fetch('/auth/user');
                const data = await res.json();
                user = data;
                
                if (user.isBanned) {
                    document.body.innerHTML = '<div class="d-flex justify-content-center align-items-center vh-100"><div class="text-center p-5 bg-danger text-white rounded display-4 fw-bold">‚õî ACC√àS REFUS√â<br><small class="fs-6 fw-normal">Vous avez √©t√© banni de ce site.</small></div></div>';
                    return;
                }

                const canEdit = user.isAdmin || user.isShockOfficer || user.isOfficer || user.isMarine;
                const canValidate = user.isAdmin || user.isShockOfficer || user.isOfficer;

                document.getElementById('navAdmin').style.display = user.isAdmin ? 'block' : 'none';
                document.getElementById('navSignalement').style.display = canValidate ? 'block' : 'none';
                document.getElementById('navDelais').style.display = canValidate ? 'block' : 'none';
                document.getElementById('btnAdminZone').style.display = canEdit ? 'block' : 'none';

                if (user.connecte) {
                    let badge = '<span class="badge bg-secondary">LECTURE SEUL</span>';
                    if (user.isAdmin) badge = '<span class="badge bg-warning text-dark">ADMIN</span>';
                    else if (user.isShockOfficer) badge = '<span class="badge bg-danger text-white">OFFICIER SHOCK</span>';
                    else if (user.isOfficer) badge = '<span class="badge bg-danger">SHOCK</span>';
                    else if (user.isMarine) badge = '<span class="badge bg-info text-dark">ACCR√âDIT√â</span>';
                    
                    const safeNick = escapeHtml(data.nickname);
                    document.getElementById('userZone').innerHTML = `<div class="d-flex align-items-center gap-2"><img src="${data.avatar}" class="avatar"><span class="fw-bold">${safeNick}</span>${badge}<a href="/auth/logout" class="btn btn-sm btn-outline-danger"><i class="fas fa-sign-out-alt"></i></a></div>`;
                    
                    document.getElementById('loginWarning').style.display = 'none';
                    if(canValidate) changerOnglet('signalement'); else chargerEnCours();
                } else {
                    document.getElementById('userZone').innerHTML = `<a href="/auth/discord" class="btn btn-outline-light btn-sm"><i class="fab fa-discord"></i> Connexion</a>`;
                    document.getElementById('btnAdminZone').style.display = 'none';
                    document.getElementById('loginWarning').style.display = 'block';
                    chargerEnCours();
                }
            } catch (e) { console.error("Erreur auth", e); }
        }

        async function fetchConfig() {
            try {
                const res = await fetch('/api/config');
                if (res.status === 403) return; 

                const data = await res.json();
                if(data) configData = { ...configData, ...data };
                if(configData.regiments.length > 0 && typeof configData.regiments[0] === 'string') {
                    configData.regiments = configData.regiments.map(r => ({ name: r, rappelDays: 10, sanctionDays: 14, sanctionText: 'Sanction par d√©faut', color: '#c0392b', discordRoleID: '' }));
                }
                renderRegimentsSelect();
            } catch(e) {}
        }

        function renderRegimentsSelect() {
            const opts = (configData.regiments || []).map(r => `<option value="${escapeHtml(r.name)}">${escapeHtml(r.name)}</option>`).join('');
            document.getElementById('cibleRegiment').innerHTML = '<option value="" disabled selected>Choisir...</option>' + opts;
            document.getElementById('sigCibleRegiment').innerHTML = '<option value="" disabled selected>Choisir...</option>' + opts;
        }

        function toggleForm() {
            const panel = document.getElementById('protocolFormPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function changerOnglet(type) {
            resetForm();
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            if(type === 'signalement') document.querySelector('a[onclick="changerOnglet(\'signalement\')"]').classList.add('active');
            if(type === 'encours') document.querySelector('a[onclick="changerOnglet(\'encours\')"]').classList.add('active');
            if(type === 'delais') document.querySelector('a[onclick="changerOnglet(\'delais\')"]').classList.add('active');
            if(type === 'historique') document.querySelector('a[onclick="changerOnglet(\'historique\')"]').classList.add('active');
            if(type === 'admin') document.querySelector('a[onclick="changerOnglet(\'admin\')"]').classList.add('active');
            
            document.getElementById('adminConfigPanel').style.display = 'none';
            document.getElementById('listeSection').style.display = 'block';
            document.getElementById('protocolFormPanel').style.display = 'none';
            document.getElementById('signalementPanel').style.display = 'none';
            document.getElementById('btnAdminZone').style.display = 'none';

            if(type === 'admin') {
                if(!user.isAdmin) return customAlert("Acc√®s refus√©");
                document.getElementById('listeSection').style.display = 'none';
                document.getElementById('adminConfigPanel').style.display = 'block';
                renderAdminUI();
            } else if(type === 'signalement') {
                document.getElementById('listeSection').style.display = 'none';
                document.getElementById('signalementPanel').style.display = 'block';
                document.getElementById('titreListe').innerHTML = '<span class="text-signal">‚ñ∫</span> Signalement Protocole';
            } else if(type === 'delais') {
                document.getElementById('titreListe').innerHTML = '<span class="text-danger">‚ñ∫</span> D√©lai Protocole';
                chargerDelais();
            } else if(type === 'encours') {
                document.getElementById('titreListe').innerHTML = '<span class="text-shock">‚ñ∫</span> Liste des Protocoles √† Remettre';
                if (user.isAdmin || user.isOfficer || user.isMarine || user.isShockOfficer) document.getElementById('btnAdminZone').style.display = 'block';
                chargerEnCours();
            } else {
                document.getElementById('titreListe').innerHTML = '<span class="text-shock">‚ñ∫</span> Archives';
                chargerHistorique();
            }
        }

        async function chargerDelais() {
            const res = await fetch('/api/protocoles'); 
            if (res.status === 403) return; 

            const data = await res.json();
            currentData = data; 
            const container = document.getElementById('listeProtocoles');
            container.innerHTML = '';
            
            let count = 0;
            const now = new Date();

            data.forEach(p => {
                const regConfig = configData.regiments.find(r => r.name === p.cibleRegiment);
                if(!regConfig) return;

                const dateCreation = new Date(p.date);
                const limitDate = new Date(dateCreation);
                limitDate.setDate(limitDate.getDate() + regConfig.rappelDays);
                const triggerRappel = new Date(limitDate);
                triggerRappel.setDate(triggerRappel.getDate() + 1);
                triggerRappel.setHours(0, 0, 0, 0);

                if (now >= triggerRappel) {
                    count++;
                    let sanctionBanner = '';
                    let deadlineText = '';

                    if (p.rappelDate) {
                        const datePriseEnCharge = new Date(p.rappelDate);
                        const deadline = new Date(datePriseEnCharge);
                        deadline.setDate(deadline.getDate() + regConfig.sanctionDays);
                        const deadlineStr = deadline.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });

                        deadlineText = `<div class="text-white mt-1 small">A jusqu'au <strong>${deadlineStr}</strong> inclus pour effectuer le protocole.</div>`;

                        const triggerBanner = new Date(deadline);
                        triggerBanner.setDate(triggerBanner.getDate() + 1);
                        triggerBanner.setHours(0, 0, 0, 0);

                        if (now >= triggerBanner) {
                            sanctionBanner = `<div class="sanction-alert">${escapeHtml(regConfig.sanctionText)} √Ä APPLIQUER</div>`;
                        }
                    }

                    const retardMs = now - limitDate;
                    const retardJours = Math.floor(retardMs / (1000 * 60 * 60 * 24)) + 1;

                    afficherRappels(container, p, regConfig, retardJours, sanctionBanner, deadlineText);
                }
            });
            document.getElementById('compteur').innerText = `${count} d√©lais d√©pass√©s`;
            if(count === 0) container.innerHTML = `<div class="col-12 text-center py-5 text-muted"><h3>‚úÖ Aucun d√©lai d√©pass√©.</h3></div>`;
        }

        function afficherRappels(container, p, regConfig, retardJours, sanctionBanner, deadlineText) {
            const regColor = getRegimentColor(p.cibleRegiment);
            const headerStyle = `background-color: ${regColor}33; border-bottom: 1px solid #c0392b; color: white; font-weight: bold;`;

            const btnGen = `<button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="generateAndShow('${p._id}')">üìÑ G√©n√©rer le Message Discord</button>`;

            let statusPriseEnCharge = p.rappelPrisEnChargeBy 
                ? `<div class="text-success fw-bold mt-2"><i class="fas fa-check"></i> Pris en charge par ${escapeHtml(p.rappelPrisEnChargeBy)}</div>${deadlineText}` 
                : `<div class="text-warning fw-bold mt-2"><i class="fas fa-clock"></i> Pas encore pris en charge</div>`;

            container.innerHTML += `
            <div class="col-12">
                <div class="card h-100 rappel-card" style="background-color: #2b2b2b !important;">
                    <div class="card-header d-flex justify-content-between align-items-center" style="${headerStyle}">
                        <span>‚ö†Ô∏è D√âLAI D√âPASS√â : ${escapeHtml(p.cibleNom)}</span>
                        <small style="color:#e74c3c; font-weight:bold;">D√©pass√© de ${retardJours-1} jours</small>
                    </div>
                    <div class="card-body">
                        ${sanctionBanner}
                        <div class="row">
                            <div class="col-md-8">
                                <p><strong>Clone √† Sanctionner :</strong> ${escapeHtml(p.cibleGrade)} ${escapeHtml(p.cibleNom)} (${escapeHtml(p.cibleRegiment)})<br>
                                <strong>Protocole :</strong> ${escapeHtml(p.protocoleType)}<br>
                                <strong>Date du Protocole :</strong> ${new Date(p.date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' })}</p>
                                ${btnGen}
                                <div id="gen-${p._id}" style="display:none;">
                                    <div class="generated-box mb-2" id="title-${p._id}" onclick="copyText(this.innerText)"></div>
                                    <div class="generated-box mb-2" id="body-${p._id}" onclick="copyText(this.innerText)"></div>
                                    <div class="d-flex gap-2">
                                        <button onclick="validerRappel('${p._id}')" class="btn btn-success btn-sm flex-grow-1">‚úÖ Valider Prise en Charge</button>
                                        <button onclick="toggleBox('${p._id}')" class="btn btn-secondary btn-sm">Annuler</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 border-start border-secondary d-flex align-items-center justify-content-center flex-column">
                                ${statusPriseEnCharge}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function getRegimentColor(regimentName) {
            const reg = configData.regiments.find(r => r.name === regimentName);
            return reg && reg.color ? reg.color : '#c0392b';
        }

        function copyText(text) { navigator.clipboard.writeText(text); customAlert('Texte copi√© !'); }

        function afficherMandats(data, estEnCours) {
            const container = document.getElementById('listeProtocoles');
            container.innerHTML = '';
            
            if (estEnCours) {
                document.getElementById('compteur').innerText = `${data.length} protocoles √† remettre`;
            } else {
                document.getElementById('compteur').innerText = `${data.length} archives`;
            }
            
            if(data.length === 0) { container.innerHTML = `<div class="col-12 text-center py-5 text-muted"><h3 class="fw-light">Aucun dossier.</h3></div>`; return; }

            data.forEach(p => {
                const isDone = p.statut === 'Effectu√©';
                const badge = isDone ? '<span class="badge badge-done rounded-pill px-3 py-2">‚úÖ EFFECTU√â</span>' : '<span class="badge badge-pending rounded-pill px-3 py-2">‚è≥ EN ATTENTE</span>';
                
                const regColor = getRegimentColor(p.cibleRegiment);
                const headerStyle = `background-color: ${regColor}20; border-bottom: 2px solid ${regColor}; color: white; font-weight: bold;`;

                let actionButtons = '';
                const canEdit = user.isAdmin || user.isShockOfficer || user.isOfficer || user.isMarine;
                const canValidate = user.isAdmin || user.isShockOfficer || user.isOfficer;
                const isAuthor = (p.discordId === user.id);
                const canModify = user.isAdmin || user.isShockOfficer || isAuthor;

                let suspendedAlert = '';
                let mainButton = '';

                if (p.isSuspended) {
                    suspendedAlert = `<div class="alert-suspended">‚õî <strong>PROTOCOLE SUSPENDU</strong><br><small>Par ${escapeHtml(p.suspendedBy)} : ${escapeHtml(p.suspendReason)}</small></div>`;
                    
                    if (user.isAdmin || user.isShockOfficer) {
                        mainButton = `<button onclick="toggleSuspend('${p._id}', true)" class="btn btn-outline-warning w-100 fw-bold mb-2">üîì Lever la Suspension</button>`;
                    } else {
                        mainButton = `<button class="btn btn-secondary w-100 fw-bold mb-2" disabled>‚õî Suspendu</button>`;
                    }
                } else {
                    if (estEnCours && canValidate) {
                        mainButton = `<button onclick="valider('${p._id}')" class="btn btn-outline-success flex-grow-1 fw-bold">üëÆ‚Äç‚ôÇÔ∏è Appliquer le protocole</button>`;
                    }
                }

                let suspendBtn = '';
                if ((user.isAdmin || user.isShockOfficer) && estEnCours && !p.isSuspended) {
                    suspendBtn = `<button onclick="toggleSuspend('${p._id}', false)" class="btn btn-sm btn-outline-warning" title="Suspendre">‚è∏Ô∏è</button>`;
                }

                if (estEnCours) {
                    let editBtn = canModify && !p.isSuspended ? `<button onclick="preparerAction('${p._id}', 'modifier')" class="btn btn-outline-warning" title="Modifier">‚úèÔ∏è</button>` : '';
                    let dupBtn = `<button onclick="preparerAction('${p._id}', 'dupliquer')" class="btn btn-outline-info" title="Dupliquer">üìã</button>`;
                    
                    if (p.isSuspended) {
                        actionButtons = `<div class="card-footer bg-transparent border-top-0 pt-0">${mainButton}</div>`;
                    } else {
                        actionButtons = `<div class="card-footer bg-transparent border-top-0 pt-0 d-flex gap-2">${mainButton}${editBtn}${dupBtn}</div>`;
                    }

                } else if (!estEnCours && canValidate) {
                    actionButtons = `<div class="card-footer bg-transparent border-top-0 pt-0"><button onclick="restaurer('${p._id}')" class="btn btn-outline-light w-100 fw-bold">‚Ü©Ô∏è Restaurer</button></div>`;
                }

                let deleteBtn = '';
                if (user.isAdmin || user.isShockOfficer || (isAuthor && estEnCours)) {
                    deleteBtn = `<button onclick="supprimer('${p._id}')" class="btn btn-sm btn-danger ms-2" title="Supprimer"><i class="fas fa-trash"></i></button>`;
                }
                
                let timeAlert = (p.tempsRestant && !isDone) ? `<div class="alert-time p-2 rounded mb-2 text-center fw-bold">‚ö†Ô∏è TEMPS RESTANT : ${escapeHtml(p.tempsRestant)} min</div>` : '';
                
                let logName = p.discordNick || p.discordUser; 
                if (p.discordNick && p.discordUser && p.discordNick !== p.discordUser) logName = `${p.discordNick} (${p.discordUser})`; 
                const discordInfo = logName ? `<br><small class="text-secondary"><i class="fab fa-discord"></i> Log: ${escapeHtml(logName)}</small>` : ''; 
                
                const steamInfo = p.targetSteamID ? `<small class="text-muted d-block mt-1" style="font-size:0.7rem">${escapeHtml(p.targetSteamID)}</small>` : ''; 
                const dateStr = new Date(p.date).toLocaleString().slice(0, -3); 
                
                let validatorInfo = ''; 
                if (p.statut === 'Effectu√©') { 
                    const vName = p.validatorManualName || (p.validatorNick || p.validatorUser); 
                    if (vName) validatorInfo = `<div class="mt-2 small text-success border-top border-secondary pt-1"><i class="fas fa-check-circle"></i> Appliqu√© par : ${escapeHtml(p.validatorManualName ? p.validatorManualName + (p.validatorUser ? ` (${p.validatorUser})` : '') : vName)}</div>`; 
                }

                const styleCard = ''; 

                container.innerHTML += `
                <div class="col-12" style="${styleCard}">
                    <div class="card h-100" style="background-color: #2b2b2b !important;">
                        <div class="card-header d-flex justify-content-between align-items-center" style="${headerStyle}">
                            <div><span class="fs-5">${escapeHtml(p.cibleNom)}</span> <span class="small ms-2" style="opacity:0.8">${escapeHtml(p.cibleGrade)} - ${escapeHtml(p.cibleRegiment)}</span></div>
                            <div class="d-flex align-items-center gap-2">${badge}${suspendBtn}${deleteBtn}</div>
                        </div>
                        <div class="card-body">
                            ${suspendedAlert}
                            <div class="row">
                                <div class="col-md-9">
                                    <div class="mb-2"><div class="p-2 bg-dark rounded border border-secondary"><small class="text-muted d-block ls-1">SANCTION</small><span class="fw-bold text-danger">${escapeHtml(p.protocoleType)}</span></div></div>
                                    <div class="mb-2"><div class="p-2 bg-dark rounded border-start border-3 border-danger"><small class="text-muted d-block ls-1">RAISON</small><span class="text-light user-text">${escapeHtml(p.raison)}</span></div></div>
                                    ${p.details ? `<div class="mb-2"><div class="p-2 bg-dark rounded border-start border-3 border-warning"><small class="text-muted d-block ls-1">D√âTAILS</small><span class="text-light user-text">${escapeHtml(p.details)}</span></div></div>` : ''}
                                    ${p.targetSteamID ? `<div class="mb-2"><div class="p-2 bg-dark rounded border-start border-3 border-danger"><small class="text-muted d-block ls-1">STEAM ID</small><span class="text-light font-monospace">${escapeHtml(p.targetSteamID)}</span></div></div>` : ''}
                                    ${timeAlert}
                                </div>
                                <div class="col-md-3 border-start border-secondary ps-4 d-flex flex-column justify-content-center">
                                    <div class="small text-muted mb-1">üìÖ ${dateStr}</div>
                                    <div class="mb-1">Personne qui l'a ordonn√© : <strong>${escapeHtml(p.auteurNom) || "?"}</strong></div>
                                    ${discordInfo}
                                    ${validatorInfo}
                                </div>
                            </div>
                        </div>
                        ${actionButtons}
                    </div>
                </div>`;
            });
        }

        async function chargerEnCours() {
            const res = await fetch('/api/protocoles');
            currentData = await res.json();
            afficherMandats(currentData, true);
        }
        async function chargerHistorique() {
            const res = await fetch('/api/historique');
            currentData = await res.json();
            afficherMandats(currentData, false);
        }

        function generateAndShow(id) { 
            const p = currentData.find(item => item._id === id);
            if(!p) return;

            const regConfig = configData.regiments.find(r => r.name === p.cibleRegiment);
            const sanctionDays = regConfig ? regConfig.sanctionDays : 14;
            const sanctionText = regConfig ? regConfig.sanctionText : 'Sanction par d√©faut';

            const dateFinale = new Date(); 
            dateFinale.setDate(dateFinale.getDate() + parseInt(sanctionDays)); 
            const dateFinaleStr = dateFinale.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            
            const titlePost = `${p.cibleRegiment} ${p.cibleGrade} ${p.cibleNom} -> ${dateFinaleStr}`; 
            const bodyPost = `<:FlecheVert:990651262976528414> Protocole √† effectuer avant le ${dateFinaleStr} sinon : ${sanctionText}\n<:FlecheVert:990651262976528414> Le ping Discord\n\n...........................................................................\n\n- **Qui l'a ordonn√© :** ${p.auteurNom}\n- **Protocole :** ${p.protocoleType.replace(/Protocole\s+/i, '')}\n- **Raison :** ${p.raison}${p.details ? `\n- **D√©tails :** ${p.details}` : ''}${p.targetSteamID ? `\n- **Steam ID :** ${p.targetSteamID}` : ''}`; 
            
            document.getElementById(`title-${id}`).innerText = titlePost; 
            document.getElementById(`body-${id}`).innerText = bodyPost; 
            toggleBox(id); 
        }

        function toggleBox(id) { const el = document.getElementById(`gen-${id}`); el.style.display = el.style.display === 'none' ? 'block' : 'none'; }
        async function validerRappel(id) { const confirm = await customConfirm("Confirmer que vous prenez en charge ce rappel sur Discord ?"); if(!confirm) return; try { const res = await fetch(`${API_URL}/${id}/rappel`, { method: 'PUT' }); if(res.ok) chargerDelais(); } catch(e) { customAlert("Erreur r√©seau"); } }
        async function envoyerSignalement() { const body = { validatorManualName: document.getElementById('sigShockName').value, cibleNom: document.getElementById('sigCibleNom').value, cibleGrade: document.getElementById('sigCibleGrade').value, cibleRegiment: document.getElementById('sigCibleRegiment').value, protocoleType: document.getElementById('sigProtocole').value, auteurNom: document.getElementById('sigOrderedBy').value, raison: document.getElementById('sigRaison').value, details: document.getElementById('sigDetails').value, targetSteamID: document.getElementById('sigSteamID').value }; if(!body.validatorManualName || !body.cibleNom || !body.cibleGrade || !body.cibleRegiment || !body.protocoleType || !body.raison) return customAlert("Champs obligatoires manquants."); try { const res = await fetch('/api/protocoles/direct', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); if(res.ok) { customAlert("Enregistr√© !"); document.querySelectorAll('#signalementPanel input, #signalementPanel textarea, #signalementPanel select').forEach(i => i.value = ''); document.querySelectorAll('.nav-link')[3].click(); } else customAlert("Erreur"); } catch(e) { customAlert("Erreur connexion"); } }
        
        // --- GESTION SUSPENSION ---
        async function toggleSuspend(id, isSuspended) {
            let reason = null;
            if (!isSuspended) {
                reason = await customPrompt("Raison de la suspension ?");
                if (reason === null) return; 
            } else {
                const confirm = await customConfirm("Lever la suspension ?");
                if (!confirm) return;
            }

            try {
                const res = await fetch(`${API_URL}/${id}/suspend`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason })
                });
                if (res.ok) chargerEnCours(); 
                else customAlert("Erreur / Permission refus√©e");
            } catch (e) { customAlert("Erreur r√©seau"); }
        }

        // --- GESTION REORDER ---
        function moveRegiment(index, direction) {
            const regs = configData.regiments;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= regs.length) return;
            [regs[index], regs[newIndex]] = [regs[newIndex], regs[index]];
            renderAdminUI();
        }

        function renderAdminUI() { 
            const listAdminR = document.getElementById('listAdminRoles'); const listAdminU = document.getElementById('listAdminUsers'); const listOfficer = document.getElementById('listOfficerRoles'); const listMarine = document.getElementById('listMarineRoles'); 
            const listShockUsers = document.getElementById('listShockUsers');
            const listBannedUsers = document.getElementById('listBannedUsers');

            listAdminR.innerHTML = (configData.adminRoles||[]).map(r => `<span class="badge bg-secondary">${escapeHtml(r)} <i class="fas fa-times tag-remove" onclick="removeConfig('adminRoles', '${escapeHtml(r)}')"></i></span>`).join(''); 
            listAdminU.innerHTML = (configData.adminUsers||[]).map(r => `<span class="badge bg-secondary">${escapeHtml(r)} <i class="fas fa-times tag-remove" onclick="removeConfig('adminUsers', '${escapeHtml(r)}')"></i></span>`).join(''); 
            listOfficer.innerHTML = (configData.officerRoles||[]).map(r => `<span class="badge bg-secondary">${escapeHtml(r)} <i class="fas fa-times tag-remove" onclick="removeConfig('officerRoles', '${escapeHtml(r)}')"></i></span>`).join(''); 
            listMarine.innerHTML = (configData.marineRoles||[]).map(r => `<span class="badge bg-secondary">${escapeHtml(r)} <i class="fas fa-times tag-remove" onclick="removeConfig('marineRoles', '${escapeHtml(r)}')"></i></span>`).join(''); 
            listShockUsers.innerHTML = (configData.shockOfficerUsers||[]).map(r => `<span class="badge bg-danger">${escapeHtml(r)} <i class="fas fa-times tag-remove" onclick="removeConfig('shockOfficerUsers', '${escapeHtml(r)}')"></i></span>`).join('');
            listBannedUsers.innerHTML = (configData.bannedUsers||[]).map(r => `<span class="badge bg-danger">${escapeHtml(r)} <i class="fas fa-times tag-remove" onclick="removeConfig('bannedUsers', '${escapeHtml(r)}')"></i></span>`).join('');

            const regList = document.getElementById('regimentConfigList'); 
            regList.innerHTML = ''; 
            (configData.regiments || []).forEach((reg, index) => { 
                const currentColor = reg.color || '#c0392b'; 
                const isFirst = index === 0;
                const isLast = index === configData.regiments.length - 1;
                
                const btnUp = isFirst ? '' : `<button class="btn btn-sm btn-outline-secondary" onclick="moveRegiment(${index}, -1)" title="Monter">‚¨ÜÔ∏è</button>`;
                const btnDown = isLast ? '' : `<button class="btn btn-sm btn-outline-secondary" onclick="moveRegiment(${index}, 1)" title="Descendre">‚¨áÔ∏è</button>`;

                regList.innerHTML += `
                <div class="col-md-6 col-lg-4">
                    <div class="card border-secondary h-100">
                        <div class="card-header d-flex justify-content-between align-items-center py-2" style="border-bottom: 3px solid ${currentColor}">
                            <span class="fw-bold">${escapeHtml(reg.name)}</span>
                            <div class="d-flex gap-1">
                                ${btnUp}
                                ${btnDown}
                                <button class="btn btn-sm btn-outline-danger" onclick="removeRegiment(${index})" title="Supprimer">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            <div class="input-group input-group-sm mb-1"><span class="input-group-text bg-dark text-white border-secondary">Temps avant Rappel (j)</span><input type="number" class="form-control" value="${reg.rappelDays}" onchange="updateRegiment(${index}, 'rappelDays', this.value)"></div>
                            <div class="input-group input-group-sm mb-1"><span class="input-group-text bg-dark text-white border-secondary">Temps avant Sanction (j)</span><input type="number" class="form-control" value="${reg.sanctionDays}" onchange="updateRegiment(${index}, 'sanctionDays', this.value)"></div>
                            <div class="input-group input-group-sm mb-2"><span class="input-group-text bg-dark text-white border-secondary">Sanction</span><input type="text" class="form-control" value="${escapeHtml(reg.sanctionText)}" onchange="updateRegiment(${index}, 'sanctionText', this.value)"></div>
                            <div class="input-group input-group-sm mb-2"><span class="input-group-text bg-dark text-white border-secondary">ID R√¥le(s) Discord</span><input type="text" class="form-control" value="${escapeHtml(reg.discordRoleID || '')}" onchange="updateRegiment(${index}, 'discordRoleID', this.value)" placeholder="123456789, 987654321"></div>
                            <div class="d-flex align-items-center gap-2"><small class="text-muted">Couleur Bandeau :</small><input type="color" class="form-control form-control-color" value="${currentColor}" onchange="updateRegiment(${index}, 'color', this.value)" title="Choisir la couleur"></div>
                        </div>
                    </div>
                </div>`; 
            }); 
        }

        function addNewRegiment() { const name = document.getElementById('newRegimentName').value.trim(); if(!name) return; if(!configData.regiments) configData.regiments = []; configData.regiments.push({ name: name, rappelDays: 10, sanctionDays: 14, sanctionText: 'Protocole 6', color: '#c0392b', discordRoleID: '' }); document.getElementById('newRegimentName').value = ''; renderAdminUI(); }
        function updateRegiment(index, field, value) { if(field === 'rappelDays' || field === 'sanctionDays') value = parseInt(value); configData.regiments[index][field] = value; }
        function removeRegiment(index) { customConfirm("Supprimer ce r√©giment ?").then(ok => { if(ok) { configData.regiments.splice(index, 1); renderAdminUI(); }}); }
        function addConfig(key) { 
            let inputId = '';
            if (key === 'adminRoles') inputId = 'newAdminRole';
            else if (key === 'adminUsers') inputId = 'newAdminUser';
            else if (key === 'officerRoles') inputId = 'newOfficerRole';
            else if (key === 'marineRoles') inputId = 'newMarineRole';
            else if (key === 'shockOfficerUsers') inputId = 'newShockUser';
            else if (key === 'bannedUsers') inputId = 'newBannedUser';

            const val = document.getElementById(inputId).value.trim(); 
            if(!val) return; 
            if(!configData[key]) configData[key] = []; 
            configData[key].push(val); 
            document.getElementById(inputId).value = ''; 
            renderAdminUI(); 
        }
        function removeConfig(key, val) { configData[key] = configData[key].filter(item => item !== val); renderAdminUI(); }
        
        async function saveConfig() { 
            await fetch('/api/config', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(configData) }); 
            customAlert("Configuration sauvegard√©e !"); 
            renderRegimentsSelect(); // Met √† jour les listes d√©roulantes imm√©diatement
        }
        
        function preparerAction(id, mode) { 
            const item = currentData.find(p => p._id === id); 
            document.getElementById('auteurNom').value = item.auteurNom; 
            document.getElementById('cibleNom').value = item.cibleNom; 
            document.getElementById('cibleGrade').value = item.cibleGrade; 
            document.getElementById('cibleRegiment').value = item.cibleRegiment; 
            document.getElementById('steamid').value = item.targetSteamID || ''; 
            document.getElementById('protocole').value = item.protocoleType; 
            document.getElementById('raison').value = item.raison; 
            document.getElementById('details').value = item.details; 
            document.getElementById('tempsRestant').value = item.tempsRestant || ''; 
            document.getElementById('protocolFormPanel').style.display = 'block'; 
            document.getElementById('protocolFormPanel').scrollIntoView({ behavior: 'smooth' }); 
            if(mode === 'modifier') { editingId = id; document.getElementById('formTitle').innerText = "üìù MODIFICATION"; document.getElementById('btnSubmit').innerText = "Sauvegarder"; document.getElementById('btnSubmit').className = "btn btn-warning btn-lg px-5"; document.getElementById('btnCancel').style.display = "inline-block"; } else { editingId = null; document.getElementById('formTitle').innerText = "üìã DUPLICATION"; document.getElementById('btnSubmit').innerText = "Cr√©er la copie"; document.getElementById('btnSubmit').className = "btn btn-shock btn-lg px-5"; document.getElementById('btnCancel').style.display = "inline-block"; } 
        }
        
        function resetForm() { 
            editingId = null; 
            document.getElementById('formTitle').innerText = "üï∞Ô∏è ORDONNER UN PROTOCOLE √Ä REMETTRE"; 
            document.getElementById('btnSubmit').innerText = "Transmettre"; 
            document.getElementById('btnSubmit').className = "btn btn-signal btn-lg px-5"; 
            document.getElementById('btnCancel').style.display = "none"; 
            document.getElementById('cibleNom').value = ''; 
            document.getElementById('cibleGrade').value = ''; 
            document.getElementById('cibleRegiment').value = ''; 
            document.getElementById('steamid').value = ''; 
            document.getElementById('protocole').value = ''; 
            document.getElementById('raison').value = ''; 
            document.getElementById('details').value = ''; 
            document.getElementById('tempsRestant').value = '';
            document.getElementById('notifyManager').checked = false;
        }

        async function envoyerProtocole() { 
            const body = { 
                auteurNom: document.getElementById('auteurNom').value, 
                cibleNom: document.getElementById('cibleNom').value, 
                cibleGrade: document.getElementById('cibleGrade').value, 
                cibleRegiment: document.getElementById('cibleRegiment').value, 
                targetSteamID: document.getElementById('steamid').value, 
                protocoleType: document.getElementById('protocole').value, 
                raison: document.getElementById('raison').value, 
                details: document.getElementById('details').value, 
                tempsRestant: document.getElementById('tempsRestant').value,
                notifyManager: document.getElementById('notifyManager').checked 
            }; 
            
            if(!body.cibleNom || !body.cibleGrade || !body.cibleRegiment || !body.protocoleType || !body.raison || !body.auteurNom) 
                return customAlert("Champs obligatoires manquants."); 
            
            if(body.notifyManager && !body.tempsRestant)
                return customAlert("Pour pr√©venir le g√©rant, veuillez indiquer le temps restant.");

            const method = editingId ? 'PUT' : 'POST'; 
            const url = editingId ? `${API_URL}/${editingId}` : API_URL; 
            
            try { 
                const res = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); 
                if(res.ok) { 
                    customAlert('‚úÖ Protocole transmis'); 
                    resetForm(); 
                    chargerEnCours(); 
                    if(!editingId) toggleForm(); 
                } else { 
                    if(res.status === 403) customAlert("Seul l'auteur ou l'admin peut modifier."); 
                    else customAlert('Erreur ou Permissions insuffisantes.'); 
                } 
            } catch(e) { customAlert("Erreur r√©seau"); } 
        }
        
        async function valider(id) { 
            const data = await askValidationDetails(); 
            if (!data) return; 

            try { 
                const res = await fetch(`${API_URL}/${id}/valider`, { 
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        validatorName: data.name,
                        validatorComment: data.comment 
                    }) 
                }); 
                if(res.ok) chargerEnCours(); 
                else customAlert("Erreur validation"); 
            } catch(e) { 
                customAlert("Erreur connexion"); 
            } 
        }
        
        function restaurer(id) {
            restoreId = id;
            document.getElementById('restoreTimeInput').value = '';
            document.getElementById('restoreNotifyInput').checked = false;
            restoreModal.show();
        }

        async function confirmerRestauration() {
            const temps = document.getElementById('restoreTimeInput').value;
            const notify = document.getElementById('restoreNotifyInput').checked;

            if (notify && !temps) {
                alert("Veuillez indiquer un temps pour envoyer la notification.");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/${restoreId}/restaurer`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tempsRestant: temps, notifyManager: notify })
                });

                if (res.ok) {
                    restoreModal.hide();
                    chargerHistorique();
                } else {
                    customAlert("Permission refus√©e");
                }
            } catch (e) { customAlert("Erreur r√©seau"); }
        }
        
        async function supprimer(id) { 
            const confirm = await customConfirm("‚ö†Ô∏è SUPPRESSION D√âFINITIVE ‚ö†Ô∏è\n√ätes-vous s√ªr ?"); 
            if(!confirm) return; 
            try { 
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' }); 
                if(res.ok) { 
                    const activeTab = document.querySelector('.nav-link.active').getAttribute('onclick'); 
                    if(activeTab.includes('encours')) chargerEnCours(); 
                    else chargerHistorique(); 
                } else {
                    const err = await res.json();
                    customAlert(err.message || "Erreur lors de la suppression."); 
                }
            } catch(e) { 
                customAlert("Erreur serveur"); 
            } 
        }
        
        init();
    </script>
</body>
</html>
