<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestion Protocoles - Coruscant Guard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --shock-red: #c0392b; --bg-dark: #0a0a0a; --card-bg: #161616; }
        body { font-family: 'Rajdhani', sans-serif; background-color: var(--bg-dark); color: #e0e0e0; background-image: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%); }
        h1, h2, h3, h4, h5, .nav-link, .btn { text-transform: uppercase; letter-spacing: 1px; }
        .text-shock { color: var(--shock-red) !important; text-shadow: 0 0 10px rgba(192, 57, 43, 0.3); }
        .btn-shock { background-color: var(--shock-red); border: none; color: white; font-weight: 600; }
        .btn-shock:hover { background-color: #a93226; box-shadow: 0 0 15px rgba(192, 57, 43, 0.5); color: white; }
        .card { background-color: var(--card-bg); border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card-header { border-bottom: 1px solid #333; background-color: rgba(192, 57, 43, 0.1); }
        .form-control, .form-select { background-color: #222; border: 1px solid #444; color: #fff; }
        .form-control:focus, .form-select:focus { background-color: #2a2a2a; border-color: var(--shock-red); color: #fff; }
        .nav-tabs { border-bottom: 2px solid #333; }
        .nav-link { color: #888; border: none; padding: 1rem 1.5rem; font-weight: 600; transition: all 0.3s; }
        .nav-link:hover { color: var(--shock-red); }
        .nav-link.active { background-color: transparent; color: var(--shock-red); border-bottom: 3px solid var(--shock-red); }
        .badge-done { background-color: #27ae60; color: white; }
        .badge-pending { background-color: #f39c12; color: #000; }
        .details-box { background-color: rgba(255,255,255,0.05); border-left: 3px solid var(--shock-red); }
        .alert-time { background-color: rgba(243, 156, 18, 0.2); border: 1px solid #f39c12; color: #f39c12; }
        .user-bar { position: absolute; top: 20px; right: 20px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--shock-red); }
    </style>
</head>
<body class="container py-5">

    <div class="user-bar" id="userZone">
        <a href="/auth/discord" class="btn btn-outline-light btn-sm">
            <i class="fab fa-discord"></i> Connexion Officier
        </a>
    </div>

    <header class="text-center mb-5 mt-4">
        <h1 class="display-4 fw-bold text-shock">Coruscant Guard</h1>
        <p class="lead text-muted">Syst√®me de Gestion des D√©tentions</p>
    </header>

    <ul class="nav nav-tabs mb-4 justify-content-center">
        <li class="nav-item"><a class="nav-link active" href="#" onclick="changerOnglet('encours')">üì° Mandats en Cours</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="changerOnglet('historique')">üíæ Archives (30 Derniers)</a></li>
    </ul>

    <div id="btnAdminZone" class="text-center mb-4" style="display:none;">
        <button class="btn btn-outline-danger btn-sm px-4 py-2" onclick="toggleAdmin()">üîí Panneau Officier</button>
    </div>

    <div id="loginWarning" class="text-center mb-4 text-muted fst-italic">
        <small>Vous devez √™tre connect√© via Discord pour effectuer des actions.</small>
    </div>

    <div class="row justify-content-center" id="adminPanel" style="display: none;">
        <div class="col-lg-10 mb-5">
            <div class="card border-danger">
                <div class="card-header text-center text-shock fw-bold py-3" id="formTitle">
                    ‚ö†Ô∏è ORDONNER UN NOUVEAU PROTOCOLE
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-7 border-end border-secondary pe-md-4">
                            <h5 class="text-muted mb-3"><i class="fas fa-bullseye"></i> Informations Cible (Prisonnier)</h5>
                            
                            <div class="mb-2">
                                <label class="small text-muted">Identit√©*</label>
                                <input type="text" id="cibleNom" class="form-control" placeholder="Matricule + Nom (Ex: CT-7567 Rex)">
                            </div>
                            
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="small text-muted">Grade*</label>
                                    <input type="text" id="cibleGrade" class="form-control" placeholder="Ex: Capitaine">
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted">R√©giment*</label>
                                    <input type="text" id="cibleRegiment" class="form-control" placeholder="Ex: 501st">
                                </div>
                            </div>

                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="small text-muted">Protocole*</label>
                                    <select id="protocole" class="form-select">
                                        <option value="" selected disabled>Choisir...</option>
                                        <option value="Protocole 1">Protocole 1</option>
                                        <option value="Protocole 2">Protocole 2</option>
                                        <option value="Protocole 3">Protocole 3</option>
                                        <option value="Protocole 4">Protocole 4</option>
                                        <option value="Protocole 5">Protocole 5</option>
                                        <option value="Protocole 6">Protocole 6</option>
                                        <option value="Protocole 7">Protocole 7</option>
                                        <option value="Protocole 8">Protocole 8</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted">Temps Restant (Optionnel)</label>
                                    <input type="text" id="tempsRestant" class="form-control border-warning text-warning" placeholder="Ex: 15min">
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <label class="small text-muted">Raison*</label>
                                <input type="text" id="raison" class="form-control" placeholder="Motif de l'arrestation">
                            </div>

                            <div class="mb-2">
                                <input type="text" id="steamid" class="form-control form-control-sm text-secondary border-secondary" placeholder="SteamID64 (Facultatif)">
                            </div>
                        </div>

                        <div class="col-md-5 ps-md-4">
                            <h5 class="text-muted mb-3"><i class="fas fa-user-shield"></i> L'Officier</h5>
                            <div class="mb-3">
                                <label class="small text-muted">Votre Nom*</label>
                                <input type="text" id="auteurNom" class="form-control" placeholder="Ex: Commander Fox">
                            </div>

                            <h5 class="text-muted mb-2 mt-4">D√©tails</h5>
                            <textarea id="details" class="form-control" rows="4" placeholder="D√©tails suppl√©mentaires (Facultatif)..."></textarea>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4 pt-3 border-top border-secondary">
                        <button id="btnSubmit" onclick="envoyerProtocole()" class="btn btn-shock btn-lg px-5">Transmettre l'Ordre</button>
                        <button id="btnCancel" onclick="resetForm()" class="btn btn-outline-secondary btn-lg px-3 ms-2" style="display:none;">Annuler</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-2">
        <h4 id="titreListe" class="m-0"><span class="text-shock">‚ñ∫</span> Liste des Mandats</h4>
        <span class="badge bg-secondary" id="compteur">0 dossiers</span>
    </div>
    
    <div id="listeProtocoles" class="row g-4"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api/protocoles';
        const API_HISTORY = '/api/historique';
        let currentData = [];
        let editingId = null; 
        let userConnecte = false;
        let isOfficier = false;

        async function checkUserStatus() {
            try {
                const res = await fetch('/auth/user');
                const data = await res.json();
                const userZone = document.getElementById('userZone');
                const btnZone = document.getElementById('btnAdminZone');
                const warning = document.getElementById('loginWarning');

                if (data.connecte) {
                    userConnecte = true;
                    isOfficier = data.isOfficier;
                    userZone.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <img src="${data.avatar}" class="avatar" alt="Avatar">
                            <span class="fw-bold">${data.username}</span>
                            ${isOfficier ? '<span class="badge bg-danger">OFFICIER</span>' : '<span class="badge bg-secondary">SOLDAT</span>'}
                            <a href="/auth/logout" class="btn btn-sm btn-outline-danger"><i class="fas fa-sign-out-alt"></i></a>
                        </div>`;
                    btnZone.style.display = isOfficier ? 'block' : 'none';
                    warning.style.display = 'none';
                    if(!isOfficier) {
                         warning.innerHTML = "<small>Vous √™tes connect√©, mais vous n'avez pas les droits pour modifier les protocoles.</small>";
                         warning.style.display = 'block';
                    }
                } else {
                    userConnecte = false;
                    isOfficier = false;
                    userZone.innerHTML = `<a href="/auth/discord" class="btn btn-outline-light btn-sm"><i class="fab fa-discord"></i> Connexion Officier</a>`;
                    btnZone.style.display = 'none';
                    warning.innerHTML = "<small>Connectez-vous pour acc√©der au syst√®me.</small>";
                    warning.style.display = 'block';
                    document.getElementById('adminPanel').style.display = 'none';
                }
                chargerEnCours(); 
            } catch (e) { console.error("Erreur auth check", e); }
        }

        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function changerOnglet(type) {
            resetForm();
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            const btnZone = document.getElementById('btnAdminZone');
            const adminPanel = document.getElementById('adminPanel');
            const titre = document.getElementById('titreListe');

            if(type === 'encours') {
                titre.innerHTML = '<span class="text-shock">‚ñ∫</span> Mandats en Cours';
                btnZone.style.display = isOfficier ? 'block' : 'none';
                chargerEnCours();
            } else {
                titre.innerHTML = '<span class="text-shock">‚ñ∫</span> Archives des Traitements';
                btnZone.style.display = 'none';
                adminPanel.style.display = 'none';
                chargerHistorique();
            }
        }

        async function chargerEnCours() {
            try {
                const response = await fetch(API_URL);
                currentData = await response.json();
                afficherCartes(currentData, true);
            } catch (e) { console.error(e); }
        }

        async function chargerHistorique() {
            try {
                const response = await fetch(API_HISTORY);
                currentData = await response.json();
                afficherCartes(currentData, false);
            } catch (e) { console.error(e); }
        }

        function preparerAction(id, mode) {
            const item = currentData.find(p => p._id === id);
            if(!item) return;

            // Remplissage des champs avec les nouvelles donn√©es
            document.getElementById('auteurNom').value = item.auteurNom;
            
            document.getElementById('cibleNom').value = item.cibleNom;
            document.getElementById('cibleGrade').value = item.cibleGrade;
            document.getElementById('cibleRegiment').value = item.cibleRegiment;
            document.getElementById('steamid').value = item.targetSteamID || '';

            document.getElementById('protocole').value = item.protocoleType;
            document.getElementById('raison').value = item.raison;
            document.getElementById('details').value = item.details;
            document.getElementById('tempsRestant').value = item.tempsRestant || '';

            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });

            if(mode === 'modifier') {
                editingId = id;
                document.getElementById('formTitle').innerText = "üìù MODIFICATION DU PROTOCOLE";
                document.getElementById('btnSubmit').innerText = "Sauvegarder";
                document.getElementById('btnSubmit').className = "btn btn-warning btn-lg px-5";
                document.getElementById('btnCancel').style.display = "inline-block";
            } else if(mode === 'dupliquer') {
                editingId = null;
                document.getElementById('formTitle').innerText = "üìã DUPLICATION DE PROTOCOLE";
                document.getElementById('btnSubmit').innerText = "Cr√©er la copie";
                document.getElementById('btnSubmit').className = "btn btn-shock btn-lg px-5";
                document.getElementById('btnCancel').style.display = "inline-block";
            }
        }

        function resetForm() {
            editingId = null;
            document.getElementById('formTitle').innerText = "‚ö†Ô∏è ORDONNER UN NOUVEAU PROTOCOLE";
            document.getElementById('btnSubmit').innerText = "Transmettre l'Ordre";
            document.getElementById('btnSubmit').className = "btn btn-shock btn-lg px-5";
            document.getElementById('btnCancel').style.display = "none";
            
            // Vider les champs
            document.getElementById('cibleNom').value = '';
            document.getElementById('cibleGrade').value = '';
            document.getElementById('cibleRegiment').value = '';
            document.getElementById('steamid').value = '';
            document.getElementById('protocole').value = '';
            document.getElementById('raison').value = '';
            document.getElementById('details').value = '';
            document.getElementById('tempsRestant').value = '';
        }

        function afficherCartes(data, estEnCours) {
            const container = document.getElementById('listeProtocoles');
            container.innerHTML = '';
            document.getElementById('compteur').innerText = `${data.length} dossiers`;

            if(data.length === 0) {
                container.innerHTML = `<div class="col-12 text-center py-5 text-muted"><h3 class="fw-light">Aucun dossier.</h3></div>`;
                return;
            }

            data.forEach(p => {
                const isDone = p.statut === 'Effectu√©';
                const badge = isDone 
                    ? '<span class="badge badge-done rounded-pill px-3 py-2">‚úÖ EFFECTU√â</span>' 
                    : '<span class="badge badge-pending rounded-pill px-3 py-2">‚è≥ EN ATTENTE</span>';
                
                let actionButtons = '';

                if (userConnecte && isOfficier) {
                    if(estEnCours) {
                        actionButtons = `
                        <div class="card-footer bg-transparent border-top-0 pt-0 d-flex gap-2">
                            <button onclick="valider('${p._id}')" class="btn btn-outline-success flex-grow-1 fw-bold">Confirmer</button>
                            <button onclick="preparerAction('${p._id}', 'modifier')" class="btn btn-outline-warning" title="Modifier">‚úèÔ∏è</button>
                            <button onclick="preparerAction('${p._id}', 'dupliquer')" class="btn btn-outline-info" title="Dupliquer">üìã</button>
                        </div>`;
                    } else {
                        actionButtons = `
                        <div class="card-footer bg-transparent border-top-0 pt-0">
                            <button onclick="restaurer('${p._id}')" class="btn btn-outline-light w-100 fw-bold">‚Ü©Ô∏è Restaurer en cours</button>
                        </div>`;
                    }
                }

                let timeAlert = '';
                if(p.tempsRestant && !isDone) {
                    timeAlert = `<div class="alert-time p-2 rounded mb-2 text-center fw-bold">‚ö†Ô∏è RESTANT : ${p.tempsRestant}</div>`;
                }

                const discordInfo = p.discordUser ? `<br><small class="text-secondary"><i class="fab fa-discord"></i> Log: ${p.discordUser}</small>` : '';
                const steamInfo = p.targetSteamID ? `<small class="text-muted d-block mt-1" style="font-size:0.7rem">${p.targetSteamID}</small>` : '';

                const cardStyle = estEnCours ? '' : 'opacity: 0.8; filter: grayscale(20%);';
                const dateObj = new Date(p.date);
                const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString().slice(0,5);

                const card = `
                <div class="col-md-6 col-xl-4" style="${cardStyle}">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold text-white fs-5">${p.cibleNom}</span>
                                <div class="small text-muted">${p.cibleGrade} - ${p.cibleRegiment}</div>
                            </div>
                            ${badge}
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between small text-muted mb-3">
                                <span>üìÖ ${dateStr}</span>
                                <div class="text-end">
                                    <span>Officier: ${p.auteurNom}</span>
                                    ${discordInfo}
                                </div>
                            </div>
                            
                            ${timeAlert}

                            <div class="row mb-3 g-2">
                                <div class="col-6"><div class="p-2 bg-dark rounded border border-secondary"><small class="text-muted d-block ls-1">SANCTION</small><span class="fw-bold text-danger">${p.protocoleType}</span></div></div>
                                <div class="col-6"><div class="p-2 bg-dark rounded border border-secondary"><small class="text-muted d-block ls-1">RAISON</small><span class="fw-bold">${p.raison}</span></div></div>
                            </div>
                            ${p.details ? `<div class="details-box p-3 rounded bg-dark text-light small fst-italic mb-2">" ${p.details} "</div>` : ''}
                            ${steamInfo}
                        </div>
                        ${actionButtons}
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        }
        
        async function envoyerProtocole() {
            const cibleNom = document.getElementById('cibleNom').value;
            const cibleGrade = document.getElementById('cibleGrade').value;
            const cibleRegiment = document.getElementById('cibleRegiment').value;
            const protocole = document.getElementById('protocole').value;
            const raison = document.getElementById('raison').value;
            const auteurNom = document.getElementById('auteurNom').value;

            // V√©rification des champs obligatoires
            if(!cibleNom || !cibleGrade || !cibleRegiment || !protocole || !raison || !auteurNom) {
                alert("‚ùå Merci de remplir tous les champs obligatoires (Identit√©, Grade, R√©giment, Protocole, Raison, Nom Officier).");
                return;
            }

            const body = {
                auteurNom: auteurNom,
                cibleNom: cibleNom,
                cibleGrade: cibleGrade,
                cibleRegiment: cibleRegiment,
                targetSteamID: document.getElementById('steamid').value,
                protocoleType: protocole,
                raison: raison,
                details: document.getElementById('details').value,
                tempsRestant: document.getElementById('tempsRestant').value
            };

            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `${API_URL}/${editingId}` : API_URL;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if(response.ok) {
                    alert('‚úÖ Op√©ration r√©ussie');
                    resetForm();
                    chargerEnCours();
                    if(!editingId) toggleAdmin();
                } else if (response.status === 401) {
                    alert('‚ùå Session expir√©e ou Droits insuffisants.');
                    window.location.reload();
                } else if (response.status === 403) {
                     alert('‚õî Vous n\'avez pas la permission Officier.');
                } else { 
                    alert('‚ùå Erreur serveur.'); 
                }
            } catch(e) { alert("Erreur connexion."); }
        }

        async function valider(id) {
            if(!confirm("Valider ce protocole ?")) return;
            try {
                const res = await fetch(`${API_URL}/${id}/valider`, { method: 'PUT' });
                if(res.status === 401 || res.status === 403) return alert("Droits insuffisants");
                chargerEnCours();
            } catch(e) {}
        }

        async function restaurer(id) {
            const nouveauTemps = prompt("Temps restant ? (Laisser vide si inchang√©)");
            try {
                const res = await fetch(`${API_URL}/${id}/restaurer`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tempsRestant: nouveauTemps })
                });
                if(res.status === 401 || res.status === 403) return alert("Droits insuffisants");
                chargerHistorique();
            } catch(e) { console.error(e); }
        }

        checkUserStatus();

    </script>
</body>
</html>
