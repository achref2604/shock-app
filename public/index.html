<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion Protocoles - Shock Troopers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Courier New', Courier, monospace; }
        .card { background-color: #1e1e1e; border: 1px solid #333; }
        .btn-shock { background-color: #8b0000; color: white; border: none; }
        .btn-shock:hover { background-color: #a00000; }
        .text-shock { color: #d32f2f; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Style des onglets */
        .nav-tabs .nav-link { color: #888; border: none; }
        .nav-tabs .nav-link.active { background-color: #1e1e1e; color: #d32f2f; border: 1px solid #333; border-bottom: none; }
        .badge-done { background-color: #2e7d32; }
    </style>
</head>
<body class="container py-5">

    <h1 class="text-center text-shock mb-4">Coruscant Guard</h1>

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" href="#" onclick="changerOnglet('encours')">üìÇ En Cours</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="changerOnglet('historique')">üóÑÔ∏è Archives (30 max)</a>
        </li>
    </ul>

    <div id="btnAdminZone" class="text-center mb-4">
        <button class="btn btn-outline-secondary btn-sm" onclick="toggleAdmin()">üîí Acc√®s Officier</button>
    </div>

    <div class="row" id="adminPanel" style="display: none;">
        <div class="col-12 mb-4">
            <div class="card p-3 border-danger">
                <h4 class="mb-3 text-danger">Ordonner un Protocole</h4>
                <div class="row">
                    <div class="col-md-6">
                        <input type="password" id="authCode" class="form-control mb-2 bg-dark text-white border-secondary" placeholder="Code Officier">
                        <input type="text" id="matricule" class="form-control mb-2 bg-dark text-white border-secondary" placeholder="Matricule">
                        <input type="text" id="nom" class="form-control mb-2 bg-dark text-white border-secondary" placeholder="Nom">
                        <select id="grade" class="form-control mb-2 bg-dark text-white border-secondary">
                            <option>Cadet</option><option>Trooper</option><option>Sergent</option>
                            <option>Lieutenant</option><option>Capitaine</option><option>Commandant</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="steamid" class="form-control mb-2 bg-dark text-white border-secondary" placeholder="SteamID64 Cible">
                        <input type="text" id="protocole" class="form-control mb-2 bg-dark text-white border-secondary" placeholder="Sanction">
                        <input type="text" id="raison" class="form-control mb-2 bg-dark text-white border-secondary" placeholder="Raison">
                        <textarea id="details" class="form-control mb-2 bg-dark text-white border-secondary" placeholder="D√©tails"></textarea>
                        <button onclick="envoyerProtocole()" class="btn btn-shock w-100">Envoyer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="titreListe" class="h4 mb-3">Mandats en cours</div>
    <div id="listeProtocoles" class="row">
        </div>

    <script>
        const API_URL = '/api/protocoles'; // API En cours
        const API_HISTORY = '/api/historique'; // API Historique
        let ongletActuel = 'encours';

        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function changerOnglet(type) {
            ongletActuel = type;
            // Gestion visuelle des onglets
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            const btnZone = document.getElementById('btnAdminZone');
            const adminPanel = document.getElementById('adminPanel');
            const titre = document.getElementById('titreListe');

            if(type === 'encours') {
                titre.innerText = "Mandats en cours";
                btnZone.style.display = 'block';
                chargerEnCours();
            } else {
                titre.innerText = "Archives (Derniers 30 trait√©s)";
                btnZone.style.display = 'none';
                adminPanel.style.display = 'none'; // On cache le formulaire dans l'historique
                chargerHistorique();
            }
        }

        async function chargerEnCours() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                afficherCartes(data, true);
            } catch (e) { console.error(e); }
        }

        async function chargerHistorique() {
            try {
                const response = await fetch(API_HISTORY);
                const data = await response.json();
                afficherCartes(data, false);
            } catch (e) { console.error(e); }
        }

        function afficherCartes(data, estEditable) {
            const container = document.getElementById('listeProtocoles');
            container.innerHTML = '';

            if(data.length === 0) {
                container.innerHTML = '<div class="col-12 text-muted text-center">Aucun dossier.</div>';
                return;
            }

            data.forEach(p => {
                const badge = p.statut === 'Effectu√©' 
                    ? '<span class="badge badge-done">EFFECTU√â</span>' 
                    : '<span class="badge bg-warning text-dark">EN ATTENTE</span>';
                
                // Bouton valider seulement si on est dans l'onglet "En cours"
                const btnValider = estEditable 
                    ? `<button onclick="valider('${p._id}')" class="btn btn-sm btn-outline-success w-100 mt-2">‚úÖ Traiter le dossier</button>` 
                    : '';

                // Style un peu plus sombre pour l'historique
                const opacity = estEditable ? '1' : '0.7';

                const card = `
                <div class="col-md-6 mb-3" style="opacity: ${opacity}">
                    <div class="card h-100 p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="m-0 text-white">${p.targetSteamID}</h5>
                            ${badge}
                        </div>
                        <div class="small text-muted mb-2">${new Date(p.date).toLocaleString()}</div>
                        
                        <div class="mb-2">
                            <span class="text-danger fw-bold">SANCTION:</span> ${p.protocoleType}<br>
                            <span class="text-danger fw-bold">RAISON:</span> ${p.raison}
                        </div>
                        
                        <div class="alert alert-dark p-2 small mb-2 text-white-50 border-secondary">
                            ${p.details}
                        </div>
                        
                        <div class="small text-end fst-italic text-muted">
                            Officier: ${p.auteurGrade} ${p.auteurNom}
                        </div>
                        ${btnValider}
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        }

        async function envoyerProtocole() {
            const auth = document.getElementById('authCode').value;
            const body = {
                auteurMatricule: document.getElementById('matricule').value,
                auteurNom: document.getElementById('nom').value,
                auteurGrade: document.getElementById('grade').value,
                targetSteamID: document.getElementById('steamid').value,
                protocoleType: document.getElementById('protocole').value,
                raison: document.getElementById('raison').value,
                details: document.getElementById('details').value
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': auth },
                body: JSON.stringify(body)
            });

            if(response.ok) {
                document.getElementById('details').value = ''; // Reset juste les d√©tails
                alert('Ordre transmis.');
                chargerEnCours();
            } else {
                alert('Code Officier Incorrect.');
            }
        }

        async function valider(id) {
            const auth = prompt("Confirmation Officier (Code d'acc√®s) :");
            if(!auth) return;

            const response = await fetch(`${API_URL}/${id}/valider`, {
                method: 'PUT',
                headers: { 'Authorization': auth }
            });

            if(response.ok) {
                // On recharge la liste pour voir qu'il a disparu de "En cours"
                chargerEnCours();
            } else {
                alert("Acc√®s refus√©.");
            }
        }

        // D√©marrage
        chargerEnCours();
    </script>
</body>
</html>
